<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${receiver != null} ? 'DMチャット - ' + ${receiver.name} : 'DMチャット'"></title>
    <link th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" rel="stylesheet" />
    <script th:src="@{/webjars/sockjs-client/1.5.1/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/2.3.4/stomp.min.js}"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { font-family: 'Helvetica', 'Arial', sans-serif; background:#e5ddd5; margin:0; padding:0; }
        .chat-container { max-width:600px; margin:0 auto; background:#fff; border-radius:0; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
        .chat-header { background:#075e54; color:white; padding:15px; font-size:18px; font-weight:bold; display:flex; align-items:center; }
        .chat-header a { color:white; margin-right: 15px; text-decoration: none; }
        .message-area { flex-grow:1; overflow-y:scroll; padding:15px; }
        .message { display:flex; margin-bottom:10px; }
        .my-message { justify-content:flex-end; }
        .other-message { justify-content:flex-start; }
        .message-content { padding:8px 12px; border-radius:15px; max-width:70%; word-wrap:break-word; }
        .my-message .message-content { background:#dcf8c6; color:#000; border-bottom-right-radius:2px; }
        .other-message .message-content { background:#fff; color:#000; border:1px solid #ddd; border-bottom-left-radius:2px; }
        .input-area { padding:10px; background:#f0f0f0; border-top:1px solid #ddd; display:flex; }
        .input-area input { flex-grow:1; padding:10px; border-radius:20px; border:none; margin-right:10px; }
        .input-area button { background:#075e54; color:white; border:none; border-radius:50%; width:40px; height:40px; font-size:20px; line-height:1; cursor:pointer; }
    </style>
</head>
<body>
  
    <div class="chat-container">
        
        <div class="chat-header">
            <a th:href="@{/teacher-list}"><i class="bi bi-arrow-left"></i></a>
            <span th:text="${receiver != null} ? ${receiver.name} : 'DMチャット'"></span>
        </div>

        <div class="message-area" id="messageArea">
            <div th:each="message : ${messages}" 
                 th:classappend="${message.userId == sender.usersId} ? 'my-message' : 'other-message'"
                 class="message">
                <div class="message-content" th:text="${message.body}"></div>
            </div>
        </div>

        <div class="input-area">
            <form id="messageForm" style="display:flex; width:100%;">
                <input type="text" id="messageInput" placeholder="メッセージを入力..." autocomplete="off" />
                <button type="submit" id="sendButton"><i class="bi bi-send-fill"></i></button>
            </form>
        </div>
    </div>

<script th:inline="javascript">
    /*<![CDATA[*/
    
    // Thymeleafから値を受け取る (変数の型修正に対応済み)
    const currentUserId = /*[[${sender.usersId}]]*/ 0;
    const roomId = /*[[${room.roomId}]]*/ 0;

    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const messageArea = document.getElementById('messageArea');
    
    let stompClient = null;

    // 画面にメッセージを追加する関数
    function appendMessage(messageDto) {
        const isMyMessage = messageDto.userId === currentUserId;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + (isMyMessage ? 'my-message' : 'other-message');
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = messageDto.body; // DTOのフィールド名 'body' に対応
        
        messageDiv.appendChild(contentDiv);
        messageArea.appendChild(messageDiv);
        
        scrollToBottom();
    }
    
    // 最下部へスクロール
    function scrollToBottom() {
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // WebSocket接続
    function connect() {
        if (!roomId || roomId <= 0) {
             console.error('Room ID is invalid. Skipping WebSocket connection.');
             return;
        }

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        
        stompClient.connect({}, (frame) => {
            console.log('Connected: ' + frame);

            // ルームごとのトピックを購読
            stompClient.subscribe('/topic/room/' + roomId, (chatMessage) => {
                const messageDto = JSON.parse(chatMessage.body);
                appendMessage(messageDto);
            });
            
        }, (error) => {
            console.error('STOMP Error:', error);
        });
    }

    // メッセージ送信
    function sendMessage(event) {
        event.preventDefault();
        const content = messageInput.value.trim();
        
        if (content && stompClient) {
            const chatMessage = {
                roomId: roomId, 
                userId: currentUserId, // DTOに合わせて 'userId'
                content: content
            };
            
            stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
            
            // 自分のメッセージは即座に画面に反映（サーバーからのブロードキャストを待たずに表示させたい場合）
            // ここでは二重表示を防ぐため、サーバーからのブロードキャストで統一する場合はこの下3行をコメントアウトしてもOKですが、
            // ユーザー体験向上のため残しておきます（ただしブロードキャスト受信時にID判定などで重複チェックが必要になる場合があります。
            // 今回はシンプルな実装として、送信時は画面に追加せず、受信時のみ追加する形にするのが安全ですが、
            // 元のコードに合わせて「送信時にも追加」しています。※二重表示になる場合はここを削除してください）
            
            /* // もし二重に表示される場合は、このブロックを削除してください
            const myMessageDto = {
                userId: currentUserId,
                body: content
            };
            appendMessage(myMessageDto); 
            */

            messageInput.value = '';
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        scrollToBottom();
        connect();
        messageForm.addEventListener('submit', sendMessage); 
    });

    /*]]>*/
</script>
</body>
</html>
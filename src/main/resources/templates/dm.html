<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${receiver != null} ? 'DMチャット - ' + ${receiver.name} : 'DMチャット'"></title>
  <link th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" rel="stylesheet" />
  <script th:src="@{/webjars/sockjs-client/1.5.1/sockjs.min.js}"></script>
  <script th:src="@{/webjars/stomp-websocket/2.3.4/stomp.min.js}"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { font-family: 'Helvetica', 'Arial', sans-serif; background:#e5ddd5; margin:0; padding:0; }
    .chat-container { max-width:600px; margin:0 auto; background:#fff; border-radius:0; display:flex; flex-direction:column; height:100vh; overflow:hidden; }
    .chat-header { background:#075e54; color:white; padding:15px; font-size:18px; font-weight:bold; display:flex; align-items:center; }
    .chat-header a { color:white; margin-right: 15px; text-decoration: none; }
    .message-area { flex-grow:1; overflow-y:scroll; padding:15px; }
    .message { display:flex; margin-bottom:10px; }
    .my-message { justify-content:flex-end; }
    .other-message { justify-content:flex-start; }
    .message-content { padding:8px 12px; border-radius:15px; max-width:70%; word-wrap:break-word; }
    .my-message .message-content { background:#dcf8c6; color:#000; border-bottom-right-radius:2px; }
    .other-message .message-content { background:#fff; color:#000; border:1px solid #ddd; border-bottom-left-radius:2px; }
    .input-area { padding:10px; background:#f0f0f0; border-top:1px solid #ddd; display:flex; }
    .input-area input { flex-grow:1; padding:10px; border-radius:20px; border:none; margin-right:10px; }
    .input-area button { background:#075e54; color:white; border:none; border-radius:50%; width:40px; height:40px; font-size:20px; line-height:1; cursor:pointer; }
  </style>
</head>
<body>

  <div id="data-container"
       th:data-room-id="${room?.id}"
       th:data-sender-id="${sender?.id}">
  </div>

  <div class="chat-container">

    <div class="chat-header">
      <a th:href="@{/user-search}"><i class="bi bi-arrow-left"></i></a>
      <span th:text="${receiver != null} ? ${receiver.name} : 'DMチャット'"></span>
    </div>

    <div class="message-area" id="messageArea">
      <div th:each="message : ${messages}"
           th:classappend="${message.senderUserId == sender.id} ? 'my-message' : 'other-message'"
           class="message">
        <div class="message-content" th:text="${message.content}"></div>
      </div>
    </div>

    <div class="input-area">
      <form id="messageForm" style="display:flex; width:100%;">
        <input type="text" id="messageInput" placeholder="メッセージを入力..." autocomplete="off" />
        <button type="submit" id="sendButton"><i class="bi bi-send-fill"></i></button> </form>
    </div>
  </div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // HTML要素からデータを取得する
    const dataContainer = document.getElementById('data-container');
    const senderId = Number(dataContainer.dataset.senderId) || null; // null許容に変更
    const roomId = Number(dataContainer.dataset.roomId) || null; // null許容に変更
    // receiverId は HTML テンプレートから直接取得 (receiver.id -> receiver.getId())
    const receiverId = /*[[${receiver?.id}]]*/ null; // null安全演算子を追加

    if (!senderId || !roomId) {
        console.error("送信者IDまたはルームIDが取得できませんでした。");
        // エラー表示などの処理を追加
        document.body.innerHTML = '<div class="alert alert-danger">エラー: ページ情報を取得できませんでした。</div>';
    } else {
        console.log("Room ID loaded:", roomId); // デバッグ用ログ

        // DOM要素の取得
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const messageArea = document.getElementById('messageArea');
        const sendButton = document.getElementById('sendButton');

        let stompClient = null;

        function appendMessage(content, isSender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isSender ? 'my-message' : 'other-message');
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            messageDiv.appendChild(contentDiv);
            messageArea.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function connect() {
            if (!roomId || typeof roomId !== 'number' || roomId <= 0) {
                 console.error('Room ID is invalid or missing:', roomId, '. Skipping WebSocket connection.');
                 return;
            }
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, (frame) => {
                console.log('Connected to room: ' + roomId);
                // ★★★ WebSocket購読トピックを group-chat と同じ /topic/group/ に変更 ★★★
                stompClient.subscribe('/topic/group/' + roomId, (chatMessage) => {
                    const messageDto = JSON.parse(chatMessage.body);
                    // ★★★ senderUserId は ChatMessageDto.getSenderUserId() に対応 ★★★
                    // ★★★ content は ChatMessageDto.getContent() に対応 ★★★
                    if (String(messageDto.senderUserId) !== String(senderId)) {
                        appendMessage(messageDto.content, false);
                    }
                });
            }, (error) => {
                console.error('STOMP Error: WebSocket接続に失敗しました。', error);
                // 必要ならユーザーにエラー通知
            });
        }

        function sendMessage(event) {
            if (event) {
                event.preventDefault();
            }
            const content = messageInput.value.trim();
            if (!content) return;

            if (stompClient && stompClient.connected) {
                const chatMessage = {
                    roomId: roomId,
                    senderUserId: senderId, // Users.id
                    content: content      // message body
                };
                // ★★★ 送信先は /app/chat.send (変更なし) ★★★
                stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
                appendMessage(content, true);
                messageInput.value = '';
            } else {
                 console.error("STOMPクライアントが接続されていません。");
                 alert("チャット接続が切断されています。ページをリロードして再接続してください。");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            scrollToBottom();
            connect();
            if (messageForm) {
                messageForm.addEventListener('submit', sendMessage);
            }
        });
    }
    /*]]>*/
</script>
</body>
</html>
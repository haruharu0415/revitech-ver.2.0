<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${roomName ?: 'グループチャット'}"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script th:src="@{/webjars/sockjs-client/1.5.1/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/2.3.4/stomp.min.js}"></script>
    
    <style>
        body { display: flex; flex-direction: column; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e5ddd5; }
        .chat-header { background-color: #075e54; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .chat-header h2 { margin: 0; font-size: 1.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-header a { color: white; text-decoration: none; margin-right: 15px; }
        
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .message { max-width: 70%; padding: 10px 15px; border-radius: 15px; position: relative; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
        .message.my-message { align-self: flex-end; background-color: #dcf8c6; border-bottom-right-radius: 2px; }
        .message.other-message { align-self: flex-start; background-color: #fff; border-bottom-left-radius: 2px; }
        
        .message-sender { font-size: 0.75rem; color: #555; margin-bottom: 3px; font-weight: bold; }
        
        .input-area { background-color: #f0f0f0; padding: 10px; display: flex; align-items: center; border-top: 1px solid #ddd; }
        .input-area input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; margin-right: 10px; outline: none; }
        .input-area button { background-color: #075e54; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .input-area button:hover { background-color: #064c44; }

        /* サイドバー（メンバーリスト用） */
        .sidebar { position: fixed; right: -250px; top: 0; width: 250px; height: 100%; background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.2); transition: right 0.3s; z-index: 20; padding-top: 60px; }
        .sidebar.open { right: 0; }
        .sidebar-header { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; background: #075e54; color: white; display: flex; justify-content: space-between; align-items: center; }
        .member-list { list-style: none; padding: 0; margin: 0; }
        .member-list li { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .member-icon { width: 30px; height: 30px; background: #ccc; border-radius: 50%; margin-right: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 15; display: none; }
        .overlay.open { display: block; }
    </style>
</head>
<body>

    <div class="chat-header">
        <div class="d-flex align-items-center">
            <a href="/group"><i class="bi bi-arrow-left fs-4"></i></a>
            <h2 th:text="${roomName}">ルーム名</h2>
        </div>
        <button id="toggleSidebar" class="btn btn-link text-white p-0"><i class="bi bi-list fs-3"></i></button>
    </div>

    <div class="chat-container" id="messageArea">
        </div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="メッセージを入力..." autocomplete="off">
        <button id="sendMessageButton"><i class="bi bi-send-fill"></i></button>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="sidebar" id="userListSidebar">
        <div class="sidebar-header">
            <h5 class="m-0">メンバー</h5>
            <button id="closeSidebar" class="btn-close btn-close-white"></button>
        </div>
        <ul class="member-list" id="memberList">
            </ul>
    </div>

    <script th:inline="javascript">
    /*<![CDATA[*/
    // ★★★ 変数名をJava側の変更に合わせて修正 ★★★
    const roomId = /*[[${roomId}]]*/ 0;
    const userId = /*[[${userId}]]*/ 0;
    const userName = /*[[${userName}]]*/ '自分';

    document.addEventListener('DOMContentLoaded', () => {
        if (!roomId || roomId === 0) {
            alert("ルームIDが無効です。");
            window.location.href = '/group';
            return;
        }
        initChat();
    });

    function initChat() {
        const messageArea = document.getElementById('messageArea');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const userListSidebar = document.getElementById('userListSidebar');
        const toggleSidebarButton = document.getElementById('toggleSidebar');
        const closeSidebarButton = document.getElementById('closeSidebar');
        const overlay = document.getElementById('overlay');
        
        let stompClient = null;

        // WebSocket接続
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        
        // デバッグログを抑制したい場合はコメントアウト
        // stompClient.debug = null;

        stompClient.connect({}, (frame) => {
            console.log('Connected: ' + frame);
            
            // ★★★ 購読URLを修正: /topic/room/{roomId} ★★★
            stompClient.subscribe(`/topic/room/${roomId}`, (payload) => {
                const message = JSON.parse(payload.body);
                displayMessage(message);
            });
            
            // 接続完了後に履歴とメンバーを取得
            fetchMessageHistory();
            fetchRoomMembers();
            
        }, (error) => {
            console.error('STOMP Error:', error);
            displayError("チャットサーバーへの接続に失敗しました。");
        });

        // メッセージ送信処理
        function sendMessage() {
            const content = messageInput.value.trim();
            if (content && stompClient) {
                // ★★★ 送信データのキーを修正: userId, roomId, content (bodyではない) ★★★
                const chatMessage = {
                    roomId: roomId,
                    userId: userId, // 以前は senderId だった場所
                    content: content
                };
                
                stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
                
                // 自分の画面には即時反映（二重表示防止のため、サーバーからのブロードキャストで統一しても良い）
                // ここでは即時反映させて、入力欄をクリアする
                // displayMessage({ userId: userId, senderName: userName, body: content, createdAt: new Date() });
                
                messageInput.value = '';
            }
        }

        // メッセージ表示処理
        function displayMessage(message) {
            const isMyMessage = message.userId === userId;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isMyMessage ? 'my-message' : 'other-message'}`;
            
            // 他人のメッセージなら名前を表示
            if (!isMyMessage) {
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                senderDiv.textContent = message.senderName || '不明';
                messageDiv.appendChild(senderDiv);
            }
            
            const contentDiv = document.createElement('div');
            // ★★★ DTOのフィールド名 body を使用 ★★★
            contentDiv.textContent = message.body; 
            messageDiv.appendChild(contentDiv);
            
            messageArea.appendChild(messageDiv);
            messageArea.scrollTop = messageArea.scrollHeight; // 最下部へスクロール
        }

        // 履歴取得
        async function fetchMessageHistory() {
            try {
                const response = await fetch(`/api/chat/messages/${roomId}`);
                if (!response.ok) throw new Error('Failed to fetch history');
                const messages = await response.json();
                messages.forEach(displayMessage);
            } catch (error) {
                console.error(error);
                displayError("メッセージ履歴の取得に失敗しました。");
            }
        }

        // メンバーリスト取得
        async function fetchRoomMembers() {
            try {
                // ★★★ APIエンドポイントを確認: /api/chat-rooms/{roomId}/members ★★★
                const response = await fetch(`/api/chat-rooms/${roomId}/members`);
                if (!response.ok) throw new Error('Failed to fetch members');
                const members = await response.json();
                
                const memberList = document.getElementById('memberList');
                memberList.innerHTML = '';
                
                members.forEach(member => {
                    const li = document.createElement('li');
                    
                    const icon = document.createElement('div');
                    icon.className = 'member-icon';
                    icon.textContent = member.name.charAt(0);
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = member.name;
                    
                    li.appendChild(icon);
                    li.appendChild(nameSpan);
                    memberList.appendChild(li);
                });
            } catch (error) {
                console.error(error);
            }
        }

        function displayError(msg) {
            const div = document.createElement('div');
            div.className = 'alert alert-danger m-3';
            div.textContent = msg;
            messageArea.appendChild(div);
        }

        // イベントリスナー
        sendMessageButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // サイドバー開閉
        const toggleMenu = () => {
            userListSidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        };
        
        toggleSidebarButton.addEventListener('click', toggleMenu);
        closeSidebarButton.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);
    }
    /*]]>*/
    </script>
</body>
</html>
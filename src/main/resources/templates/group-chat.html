<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${roomName ?: 'グループチャット'}"></title>
    <link th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script th:src="@{/webjars/sockjs-client/1.5.1/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/2.3.4/stomp.min.js}"></script>
    <th:block th:insert="~{header :: header-styles}"></th:block>
    <style>
        /* (スタイルは変更なし) */
        body { display: flex; flex-direction: column; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .chat-header { background-color: #075e54; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .chat-header h1 { margin: 0; font-size: 1.5rem; }
        .message-area { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #e5ddd5; }
        .message-bubble { background-color: #ffffff; padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; max-width: 75%; position: relative; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .message-bubble.sent { background-color: #dcf8c6; margin-left: auto; text-align: right; }
        .message-bubble.received { background-color: #ffffff; margin-right: auto; text-align: left; }
        .message-sender { font-size: 0.8rem; color: #666; margin-bottom: 5px; font-weight: bold; }
        .input-area { background-color: #f0f0f0; padding: 10px 15px; display: flex; align-items: center; border-top: 1px solid #ddd; }
        .input-area textarea { flex-grow: 1; resize: none; border-radius: 20px; padding: 8px 15px; border: 1px solid #ccc; margin-right: 10px; max-height: 80px; overflow-y: auto; }
        .input-area button { border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .user-list-button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
        .user-list-sidebar { position: fixed; right: 0; top: 0; height: 100%; width: 250px; background-color: #ffffff; border-left: 1px solid #eee; box-shadow: -2px 0 5px rgba(0,0,0,0.2); transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 1000; padding-top: 60px; }
        .user-list-sidebar.open { transform: translateX(0); }
        .user-list-sidebar h5 { padding: 15px; background-color: #f0f0f0; margin-top: 0; }
        .user-list-sidebar ul { list-style: none; padding: 0; margin: 0; }
        .user-list-sidebar ul li { padding: 10px 15px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div th:replace="~{header :: header-fragment}"></div> 

    <div class="chat-header">
        <a th:href="@{/group}" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i></a>
        <h1 id="chatRoomName" th:text="${roomName ?: 'グループチャット'}">グループチャット</h1>
        <button id="toggleSidebar" class="user-list-button"><i class="bi bi-people-fill"></i></button>
    </div>

    <div class="message-area" id="messageArea"></div>

    <div class="input-area">
        <textarea id="messageInput" placeholder="メッセージを入力..." rows="1"></textarea>
        <button id="sendMessageButton" class="btn btn-success"><i class="bi bi-send-fill"></i></button>
    </div>

    <div id="userListSidebar" class="user-list-sidebar">
        <h5>メンバーリスト (<span id="memberCount">0</span>)</h5>
        <ul id="memberList"></ul>
    </div>

    <script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
    <th:block th:insert="~{header :: notification-script}"></th:block>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const roomId = /*[[${roomId}]]*/ -1;
        const authenticatedUserId = /*[[${userId}]]*/ -1;

        let stompClient = null;
        let roomMembers = new Map(); // メンバーのIDと名前を保持するMap

        const messageArea = document.getElementById('messageArea');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');

        // WebSocket接続
        function connect() {
            const socket = new SockJS('/ws'); 
            stompClient = Stomp.over(socket);
            stompClient.connect({}, onConnected, onError);
        }

        function onConnected() {
            // ▼▼▼【修正点】購読先を /topic/messages/{roomId} に統一 ▼▼▼
            stompClient.subscribe('/topic/messages/' + roomId, onMessageReceived);
            // ページ読み込み時にルーム情報とメッセージ履歴を取得
            fetchRoomDetailsAndHistory();
        }

        function onError(error) {
            console.error('WebSocket接続エラー:', error);
        }

        // メッセージ送信
        function sendMessage() {
            const messageContent = messageInput.value.trim();
            if (messageContent && stompClient) {
                const chatMessage = {
                    roomId: roomId,
                    senderUserId: authenticatedUserId, 
                    content: messageContent,
                };
                stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
                
                // 自分のメッセージを即時表示
                const immediateMessage = {
                    content: messageContent,
                    senderUserId: authenticatedUserId,
                    createdAt: new Date().toISOString()
                };
                displayMessage(immediateMessage);
                
                messageInput.value = ''; 
            }
        }

        // メッセージ受信
        function onMessageReceived(payload) {
            const message = JSON.parse(payload.body);
            // 他のユーザーからのメッセージのみ表示（自分のは送信時に表示済み）
            if (String(message.senderUserId) !== String(authenticatedUserId)) {
                displayMessage(message);
            }
        }

        // メッセージをUIに表示
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble');

            const isSentByMe = String(message.senderUserId) === String(authenticatedUserId);
            messageElement.classList.add(isSentByMe ? 'sent' : 'received');

            if (!isSentByMe) {
                const senderNameElement = document.createElement('div');
                senderNameElement.classList.add('message-sender');
                // Mapから送信者名を取得、見つからなければIDを表示
                senderNameElement.textContent = roomMembers.get(message.senderUserId) || `User ${message.senderUserId}`;
                messageElement.appendChild(senderNameElement);
            }

            const textElement = document.createElement('p');
            textElement.style.margin = '0';
            textElement.textContent = message.content;
            messageElement.appendChild(textElement);

            messageArea.appendChild(messageElement);
            messageArea.scrollTop = messageArea.scrollHeight; 
        }
        
        // ルーム情報（メンバーリスト）とメッセージ履歴を取得
        async function fetchRoomDetailsAndHistory() {
            try {
                // 1. メンバーリスト取得
                const membersResponse = await fetch(`/api/chat-rooms/${roomId}/members`);
                const membersData = await membersResponse.json(); 
                
                const memberListUl = document.getElementById('memberList');
                memberListUl.innerHTML = ''; 
                membersData.forEach(member => {
                    roomMembers.set(member.id, member.name); // メンバー情報をMapに保存
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="bi bi-person-fill"></i> ${member.name}`;
                    memberListUl.appendChild(li);
                });
                document.getElementById('memberCount').textContent = membersData.length;
                
                // 2. 過去のメッセージ履歴を取得
                const historyResponse = await fetch(`/api/chat/messages/${roomId}`);
                const historyData = await historyResponse.json(); 
                
                messageArea.innerHTML = ''; // 履歴表示前にクリア
                historyData.forEach(displayMessage); // 履歴を一件ずつ表示
                
            } catch (error) {
                console.error('ルーム情報またはメッセージ履歴の取得に失敗:', error);
            }
        }
        
        // イベントリスナー
        sendMessageButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) { 
                event.preventDefault();
                sendMessage();
            }
        });
        document.getElementById('toggleSidebar').addEventListener('click', () => {
            document.getElementById('userListSidebar').classList.toggle('open');
        });

        // ページ読み込み時に実行
        document.addEventListener('DOMContentLoaded', connect);
        /*]]>*/
    </script>
</body>
</html>
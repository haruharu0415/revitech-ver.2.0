<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${roomName ?: 'グループチャット'}"></title>
    <link th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script th:src="@{/webjars/sockjs-client/1.5.1/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/2.3.4/stomp.min.js}"></script>
    
    <style th:replace="~{header :: header-styles}"></style> 
    
    <style>
        body { display: flex; flex-direction: column; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        .chat-header { background-color: #075e54; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .chat-header-title { font-size: 1.1rem; font-weight: 600; }
        .chat-header-menu { font-size: 1.5rem; cursor: pointer; }
        
        .chat-body { display: flex; flex-grow: 1; overflow: hidden; }
        
        #messageArea { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #e5ddd5; }
        
        .message-bubble { max-width: 80%; width: fit-content; padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; word-wrap: break-word; }
        .message-row { display: flex; flex-direction: column; }
        
        /* 自分のメッセージ */
        .message-row.my-message { align-items: flex-end; }
        .my-message .message-bubble { background-color: #dcf8c6; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .my-message .message-meta { text-align: right; }
        
        /* 他人のメッセージ */
        .message-row.other-message { align-items: flex-start; }
        .other-message .message-bubble { background-color: #ffffff; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        
        .message-sender { font-size: 0.8rem; font-weight: 600; color: #555; margin-bottom: 2px; }
        .message-time { font-size: 0.75rem; color: #888; margin-top: 4px; }

        /* 日付区切り */
        .date-separator { text-align: center; margin: 15px 0; }
        .date-separator span { background-color: #d4eaf4; color: #555; padding: 5px 12px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; }

        /* フッター（入力欄） */
        .chat-footer { background-color: #f0f0f0; padding: 10px 15px; display: flex; align-items: flex-end; border-top: 1px solid #ddd; }
        #messageInput { flex-grow: 1; border-radius: 20px; border: 1px solid #ccc; padding: 10px 15px; resize: none; max-height: 100px; overflow-y: auto; margin-right: 10px; }
        #sendMessageButton { border-radius: 50%; width: 45px; height: 45px; background-color: #075e54; border: none; font-size: 1.2rem; }
        
        /* サイドバー */
        #userListSidebar { position: fixed; top: 0; right: -300px; width: 300px; height: 100%; background-color: white; box-shadow: -2px 0 5px rgba(0,0,0,0.1); z-index: 100; transition: right 0.3s ease; display: flex; flex-direction: column; }
        #userListSidebar.open { right: 0; }
        .sidebar-header { padding: 15px; background-color: #075e54; color: white; font-size: 1.1rem; font-weight: 600; }
        .sidebar-body { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .sidebar-user { padding: 10px; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>

    <header class="chat-header">
        <a th:href="@{/group}" class="text-white"><i class="bi bi-arrow-left"></i></a>
        <div class="chat-header-title" th:text="${roomName ?: 'チャット'}"></div>
        <i class="bi bi-three-dots-vertical chat-header-menu" id="toggleSidebarButton"></i>
    </header>

    <div class="chat-body">
        <div id="messageArea">
            </div>

        <div id="userListSidebar">
            <div class="sidebar-header">参加メンバー</div>
            <div class="sidebar-body" id="memberListArea">
                </div>
        </div>
    </div>
    
    <footer class="chat-footer">
        <textarea id="messageInput" placeholder="メッセージを入力..." rows="1"></textarea>
        <button class="btn btn-primary" id="sendMessageButton"><i class="bi bi-send-fill"></i></button>
    </footer>

    <script th:inline="javascript">
    /*<![CDATA[*/
    
    // --- グローバル変数・定数 ---
    const roomId = /*[[${roomId}]]*/ 0;
    const currentUserId = /*[[${userId}]]*/ 0;
    const currentUserName = /*[[${userName}]]*/ 'You';
    
    const messageArea = document.getElementById('messageArea');
    const messageInput = document.getElementById('messageInput');
    const sendMessageButton = document.getElementById('sendMessageButton');
    const userListSidebar = document.getElementById('userListSidebar');
    const toggleSidebarButton = document.getElementById('toggleSidebarButton');
    const memberListArea = document.getElementById('memberListArea');

    let stompClient = null;
    let lastDisplayedDate = null; // 日付追跡用のグローバル変数

    // --- 関数定義 ---

    /**
     * ★★★ 新規追加 ★★★
     * 日付区切り線のテキストをフォーマットする（今日、昨日、または日付）
     */
    function formatDateSeparator(dateString) {
        if (!dateString) return '';
        
        const messageDate = new Date(dateString);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);

        // 年月日を比較するために文字列化する (ja-JPロケールを指定)
        const msgDateStr = messageDate.toLocaleDateString('ja-JP');
        const todayStr = today.toLocaleDateString('ja-JP');
        const yesterdayStr = yesterday.toLocaleDateString('ja-JP');

        if (msgDateStr === todayStr) {
            return '今日';
        } else if (msgDateStr === yesterdayStr) {
            return '昨日';
        } else {
            // それ以外はロケールに従った日付文字列（例: "2025/11/09"）
            return msgDateStr;
        }
    }

    /**
     * メッセージを表示エリアに追加する
     */
    function displayMessage(messageDto) {
        // 日付区切り線の処理
        if (messageDto.createdAt) {
            
            // ★★★ 修正箇所 (1/2) ★★★
            // 比較用の日付文字列 (ロケールを指定)
            const messageDateStr = new Date(messageDto.createdAt).toLocaleDateString('ja-JP');
            
            if (lastDisplayedDate !== messageDateStr) {
                lastDisplayedDate = messageDateStr;
                
                const dateDiv = document.createElement('div');
                dateDiv.className = 'date-separator';
                
                const dateSpan = document.createElement('span');
                
                // ★★★ 修正箇所 (2/2) ★★★
                // 新しいヘルパー関数を使って「今日」「昨日」表示に対応
                dateSpan.textContent = formatDateSeparator(messageDto.createdAt);
                
                dateDiv.appendChild(dateSpan);
                messageArea.appendChild(dateDiv);
            }
        }

        const messageRow = document.createElement('div');
        messageRow.className = 'message-row';

        const isMyMessage = messageDto.userId === currentUserId;
        messageRow.classList.add(isMyMessage ? 'my-message' : 'other-message');

        const messageBubble = document.createElement('div');
        messageBubble.className = 'message-bubble';

        // 送信者名 (自分以外のメッセージにのみ表示)
        if (!isMyMessage && messageDto.senderName) {
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = messageDto.senderName;
            messageBubble.appendChild(senderDiv);
        }

        // メッセージ本文
        const bodyDiv = document.createElement('div');
        bodyDiv.textContent = messageDto.body;
        messageBubble.appendChild(bodyDiv);

        // タイムスタンプ
        if (messageDto.createdAt) {
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = formatTimestamp(messageDto.createdAt);
            messageBubble.appendChild(timeDiv);
        }
        
        messageRow.appendChild(messageBubble);
        messageArea.appendChild(messageRow);

        // 常に一番下にスクロール
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    /**
     * タイムスタンプを HH:mm 形式にフォーマットする
     */
    function formatTimestamp(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    }

    /**
     * メンバー一覧をサイドバーに表示する
     */
    async function fetchAndDisplayMembers() {
        if (!roomId || roomId <= 0) return;
        try {
            const response = await fetch(`/api/chat-rooms/${roomId}/members`);
            if (!response.ok) throw new Error('メンバーの取得に失敗');
            
            const members = await response.json();
            memberListArea.innerHTML = ''; // 一旦クリア
            
            members.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'sidebar-user';
                memberDiv.textContent = member.name;
                // (もしUserSearchDtoにemailが含まれているなら)
                // memberDiv.innerHTML = `${member.name} <small class="text-muted d-block">${member.email}</small>`;
                memberListArea.appendChild(memberDiv);
            });
            
        } catch (error) {
            console.error(error);
            memberListArea.innerHTML = '<div class="alert alert-warning m-2">メンバーの取得に失敗しました。</div>';
        }
    }

    /**
     * WebSocket接続処理
     */
    function connect() {
        if (stompClient) {
             console.log("Already connected or connecting.");
             return;
        }
        
        if (!roomId || roomId <= 0) {
             console.error('Room ID is invalid. Skipping WebSocket connection.');
             return;
        }

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        
        stompClient.connect({}, (frame) => {
            console.log('Connected: ' + frame);

            // ルームのトピックを購読
            stompClient.subscribe('/topic/room/' + roomId, (chatMessage) => {
                const messageDto = JSON.parse(chatMessage.body);
                displayMessage(messageDto);
            });
            
        }, (error) => {
            console.error('STOMP Error:', error);
            displayError("チャットサーバーへの接続に失敗しました。リロードしてください。");
        });
    }

    /**
     * メッセージ送信処理
     */
    function sendMessage() {
        const content = messageInput.value.trim();
        if (content && stompClient) {
            const chatMessage = {
                roomId: roomId,
                userId: currentUserId, // 送信者ID
                content: content
            };
            
            // サーバーへメッセージ送信
            stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
            
            // 自分の画面にも即時反映 (送信者名などは不要)
            const myMessageDto = {
                userId: currentUserId,
                body: content,
                createdAt: new Date().toISOString() // 即時反映のため現在時刻
            };
            // displayMessage(myMessageDto); // サーバーからの返却を待つ（二重表示を防ぐ）

            messageInput.value = ''; // 入力欄をクリア
            adjustTextareaHeight(); // 高さをリセット
        }
    }

    /**
     * 履歴の取得とWebSocket接続の開始
     */
    async function fetchHistoryAndConnect() {
        if (!roomId || roomId <= 0) {
            displayError("チャットルームIDが無効です。");
            return;
        }
        
        try {
            // メッセージ履歴を取得
            const historyResponse = await fetch(`/api/chat/messages/${roomId}`);
            if (!historyResponse.ok) throw new Error('メッセージ履歴の取得に失敗しました。');
            const historyData = await historyResponse.json();
            
            lastDisplayedDate = null; // 日付追跡をリセット
            historyData.forEach(displayMessage);
            messageArea.scrollTop = messageArea.scrollHeight;
            
            // 履歴取得後にWebSocket接続を開始
            connect(); 
            
        } catch (error) {
            displayError(error.message);
        }
    }
    
    /**
     * エラーメッセージを表示エリアに表示する
     */
    function displayError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-warning m-2';
        errorDiv.textContent = 'エラー: ' + message;
        messageArea.appendChild(errorDiv);
    }
    
    /**
     * テキストエリアの高さを自動調整する
     */
    function adjustTextareaHeight() {
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';
    }


    // --- イベントリスナーの登録 ---

    document.addEventListener('DOMContentLoaded', () => {
        // ページ読み込み時に履歴取得＆WebSocket接続を開始
        fetchHistoryAndConnect();
        
        // メンバー一覧も取得
        fetchAndDisplayMembers();

        // 送信ボタン
        sendMessageButton.addEventListener('click', sendMessage);
        
        // Enterキーでの送信 (Shift+Enterで改行)
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        // 入力に応じた高さ調整
        messageInput.addEventListener('input', adjustTextareaHeight);
        
        // サイドバー開閉
        toggleSidebarButton.addEventListener('click', () => {
            userListSidebar.classList.toggle('open');
        });
    });

    /*]]>*/
    </script>
</body>
</html>
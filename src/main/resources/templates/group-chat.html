<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${roomName ?: 'グループチャット'}"></title>
    <link th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script th:src="@{/webjars/sockjs-client/1.5.1/sockjs.min.js}"></script>
    <script th:src="@{/webjars/stomp-websocket/2.3.4/stomp.min.js}"></script>
    <style th:replace="~{header :: header-styles}"></style> 
    <style>
     body { display: flex; flex-direction: column; height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
.chat-header { background-color: #075e54; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.2); flex-shrink: 0; }
.chat-header h1 { margin: 0; font-size: 1.5rem; }
.message-area { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #e5ddd5; }
.message-bubble {
    padding: 10px 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    max-width: 75%; /* Max width */
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    width: -moz-fit-content; /* Fit content width (Firefox) */
    width: fit-content;      /* Fit content width (Standard) */
}
.message-bubble.sent {
    background-color: #dcf8c6;
    margin-left: auto; /* Align right */
    text-align: left;  /* Text aligns left inside bubble */
}
.message-bubble.received {
    background-color: #ffffff;
    margin-right: auto; /* Align left */
    text-align: left;
}
.message-sender { font-size: 0.8rem; color: #666; margin-bottom: 5px; font-weight: bold; }
.message-time {
    font-size: 0.7rem;
    color: #999;
    margin-top: 5px;
    display: block; /* Put time on new line */
    text-align: right; /* Align time to the right */
}
.input-area { background-color: #f0f0f0; padding: 10px 15px; display: flex; align-items: center; border-top: 1px solid #ddd; flex-shrink: 0; }
.input-area textarea { flex-grow: 1; resize: none; border-radius: 20px; padding: 8px 15px; border: 1px solid #ccc; margin-right: 10px; max-height: 80px; overflow-y: auto; }
.input-area button { border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
.user-list-button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
.user-list-sidebar { position: fixed; right: 0; top: 0; height: 100%; width: 250px; background-color: #ffffff; border-left: 1px solid #eee; box-shadow: -2px 0 5px rgba(0,0,0,0.2); transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 1000; padding-top: 60px; }
.user-list-sidebar.open { transform: translateX(0); }
.user-list-sidebar h5 { padding: 15px; background-color: #f0f0f0; margin: 0; }
.user-list-sidebar ul { list-style: none; padding: 0; margin: 0; }
.user-list-sidebar ul li { padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
.user-list-sidebar ul li .bi { margin-right: 10px; color: #075e54; }
.date-separator {
    text-align: center;
    margin: 15px 0;
    font-size: 0.8rem;
    color: #555;
    background-color: rgba(210, 210, 210, 0.7);
    padding: 3px 10px;
    border-radius: 10px;
    display: inline-block;
    left: 50%;
    position: relative;
    transform: translateX(-50%);
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
}
    </style>
</head>
<body>
    <div th:replace="~{header :: header-fragment}"></div> 
    <div class="chat-header">
        <button onclick="window.location.href='/group'" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i></button>
        <h1 id="chatRoomName" th:text="${roomName ?: '不明なルーム'}"></h1>
        <button id="toggleSidebar" class="user-list-button"><i class="bi bi-people-fill"></i></button>
    </div>
    <div class="message-area" id="messageArea"></div>
    <div class="input-area">
        <textarea id="messageInput" placeholder="メッセージを入力..." rows="1"></textarea>
        <button id="sendMessageButton" class="btn btn-success"><i class="bi bi-send-fill"></i></button>
    </div>
    <div id="userListSidebar" class="user-list-sidebar">
        <h5>メンバーリスト (<span id="memberCount">0</span>)</h5>
        <ul id="memberList"></ul>
    </div>

    <script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
    <script th:inline="javascript">
    /*<![CDATA[*/
    const roomId = /*[[${roomId}]]*/ null;
    const authenticatedUserId = /*[[${userId}]]*/ null;

    if (!roomId || !authenticatedUserId) {
        document.body.innerHTML = `<div class="alert alert-danger m-3"><h4>致命的エラー</h4><p>ページの描画に必要な情報がサーバーから提供されませんでした。</p><a href="/home" class="btn btn-primary">ホームに戻る</a></div>`;
    } else {
        const messageArea = document.getElementById('messageArea');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const userListSidebar = document.getElementById('userListSidebar');
        const toggleSidebarButton = document.getElementById('toggleSidebar');
        const memberListUl = document.getElementById('memberList');
        const memberCountSpan = document.getElementById('memberCount');
        let stompClient = null;
        
        // ★★★ 最後に表示した日付を記録する変数 ★★★
        let lastDisplayedDate = null; 

        document.addEventListener('DOMContentLoaded', connect);

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, onConnected, onError);
        }

        function onConnected() {
            stompClient.subscribe('/topic/group/' + roomId, onMessageReceived);
            fetchRoomDetailsAndHistory();
        }

        function onError(error) {
            displayError("チャットサーバーへの接続に失敗しました。");
        }

        function sendMessage() {
            const messageContent = messageInput.value.trim();
            if (messageContent && stompClient) {
                stompClient.send("/app/chat.send", {}, JSON.stringify({
                    senderId: authenticatedUserId,
                    content: messageContent,
                    roomId: roomId
                }));
                messageInput.value = '';
                adjustTextareaHeight();
            }
        }

        function onMessageReceived(payload) {
            displayMessage(JSON.parse(payload.body));
        }

        // ★★★ 日付をフォーマットするヘルパー関数 ★★★
        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // 年月日が同じかチェック
            const isSameDate = (d1, d2) => 
                d1.getFullYear() === d2.getFullYear() &&
                d1.getMonth() === d2.getMonth() &&
                d1.getDate() === d2.getDate();

            if (isSameDate(date, today)) {
                return "今日";
            } else if (isSameDate(date, yesterday)) {
                return "昨日";
            } else {
                // 例: 10月28日
                return `${date.getMonth() + 1}月${date.getDate()}日`; 
            }
        }

        // ★★★ メッセージ表示関数を修正 ★★★
        function displayMessage(message) {
            const messageDateStr = new Date(message.createdAt || Date.now()).toLocaleDateString(); // "yyyy/MM/dd" 形式

            // --- 日付区切り線の挿入 ---
            if (lastDisplayedDate !== messageDateStr) {
                const dateSeparator = document.createElement('div');
                dateSeparator.classList.add('date-separator');
                dateSeparator.textContent = formatDate(message.createdAt || Date.now());
                messageArea.appendChild(dateSeparator);
                lastDisplayedDate = messageDateStr; // 最後に表示した日付を更新
            }
            // --- ここまで ---

            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble');
            if (String(message.senderUserId) === String(authenticatedUserId)) {
                messageElement.classList.add('sent');
            } else {
                messageElement.classList.add('received');
                const senderNameElement = document.createElement('div');
                senderNameElement.classList.add('message-sender');
                senderNameElement.textContent = message.senderName || '不明なユーザー';
                messageElement.appendChild(senderNameElement);
            }
            const textElement = document.createElement('p');
            // ★ メッセージ本文のスタイルを少し調整 (任意)
            textElement.style.margin = '0'; 
            textElement.textContent = message.content;
            messageElement.appendChild(textElement);
            
            const timeElement = document.createElement('span');
            timeElement.classList.add('message-time');
            // ★ 時刻表示のみに変更
            timeElement.textContent = new Date(message.createdAt || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); 
            messageElement.appendChild(timeElement);
            
            const shouldScroll = messageArea.scrollTop + messageArea.clientHeight >= messageArea.scrollHeight - 10;
            messageArea.appendChild(messageElement);
            
            if (shouldScroll) {
                messageArea.scrollTop = messageArea.scrollHeight;
            }
        }

        async function fetchRoomDetailsAndHistory() {
            try {
                const membersResponse = await fetch(`/api/room/${roomId}/members`);
                if (!membersResponse.ok) throw new Error('メンバーリストの取得に失敗しました。');
                const membersData = await membersResponse.json();
                
                memberListUl.innerHTML = '';
                membersData.forEach(member => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="bi bi-person-fill"></i> ${member.name}`;
                    memberListUl.appendChild(li);
                });
                memberCountSpan.textContent = membersData.length;

                const historyResponse = await fetch(`/api/room/${roomId}/messages`);
                if (!historyResponse.ok) throw new Error('メッセージ履歴の取得に失敗しました。');
                const historyData = await historyResponse.json();
                
                // ★★★ 履歴表示前に lastDisplayedDate をリセット ★★★
                lastDisplayedDate = null; 
                historyData.forEach(displayMessage); // displayMessage が日付区切りも表示
                
                messageArea.scrollTop = messageArea.scrollHeight;
            } catch (error) {
                displayError(error.message);
            }
        }
        
        function displayError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-warning m-2';
            errorDiv.textContent = 'エラー: ' + message;
            messageArea.appendChild(errorDiv);
        }
        
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            // ★ 高さをscrollHeightに合わせる (+2pxは微調整)
            messageInput.style.height = (messageInput.scrollHeight + 2) + 'px'; 
        }

        sendMessageButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        messageInput.addEventListener('input', adjustTextareaHeight);
        toggleSidebarButton.addEventListener('click', () => {
            userListSidebar.classList.toggle('open');
        });
    }
    /*]]>*/
    </script>
</body>
</html>
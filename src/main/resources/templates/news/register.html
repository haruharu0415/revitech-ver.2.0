<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>お知らせ登録</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        
        input[type="text"], textarea, select { 
            width: 100%; 
            padding: 8px; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        
        select[multiple] {
            height: 200px;
        }
        
        .action-button { 
            background-color: #4CAF50; 
            color: white; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            white-space: nowrap; 
        }
        .action-button:hover { background-color: #45a049; }
        
        .clear-button { background-color: #808080; }
        .clear-button:hover { background-color: #6a6a6a; }

        .back-link { display: block; margin-top: 20px; }
        .help-text { font-size: 0.85em; color: #666; margin-top: 5px; }

        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-controls input[type="text"] { flex-grow: 1; }
    </style>
</head>
<body>

    <h2>お知らせ登録</h2>

    <form th:action="@{/news/register}" th:object="${news}" method="post">
        
        <div class="form-group">
            <label for="title">件名:</label>
            <input type="text" id="title" th:field="*{title}" required>
        </div>

        <div class="form-group">
            <label for="newsBody">お知らせ本文:</label>
            <textarea id="newsBody" th:field="*{newsBody}" rows="6" required></textarea>
        </div>
        
        <div class="form-group">
            <label for="departmentSearch">学科で絞り込み:</label>
            <div class="search-controls">
                <input type="text" id="departmentSearch" placeholder="学科名の一部を入力（例: 情報）" 
                       onkeydown="if(event.key === 'Enter'){ event.preventDefault(); filterDepartmentsOnButtonClick(); }">
                
                <button type="button" onclick="filterDepartmentsOnButtonClick()" class="action-button">
                    <i class="bi bi-search"></i> 検索
                </button>
                <button type="button" onclick="clearFilter()" class="action-button clear-button">
                    <i class="bi bi-x-circle"></i> クリア
                </button>
            </div>
            <div class="help-text">「情報」と入力すれば「情報処理科」「高度情報処理科」などがヒットします。</div>
        </div>

        <div class="form-group" id="recipient-select-container">
            <label for="recipientUserIds">送信対象生徒 (複数選択可):</label>
            <select id="recipientUserIds" name="recipientUserIds" multiple required>
                <th:block th:each="entry : ${subjectUserMap}">
                    <optgroup th:label="${entry.key}">
                        <option th:each="user : ${entry.value}" th:value="${user.usersId}">
                            [[${user.name}]] ([[${user.email}]])
                        </option>
                    </optgroup>
                </th:block>
            </select>
            <div class="help-text">CtrlキーやShiftキーで複数選択できます。</div>
        </div>
        
        <button type="submit">お知らせを送信</button>
    </form>

    <a th:href="@{/news}" class="back-link">お知らせ一覧に戻る</a>
    
    <script>
        // ページ読み込み時に、全ての optgroup 要素をコピーして保存しておく変数
        let allOptgroups = [];

        window.onload = function() {
            const selectElement = document.getElementById("recipientUserIds");
            const optgroups = selectElement.getElementsByTagName("optgroup");
            
            // HTMLCollection は生きたリストなので、配列に変換してクローンを保存する
            for (let i = 0; i < optgroups.length; i++) {
                // cloneNode(true) で子要素（optionタグ）も含めてコピー
                allOptgroups.push(optgroups[i].cloneNode(true));
            }
        };

        function filterDepartmentsOnButtonClick() {
            const inputElement = document.getElementById("departmentSearch");
            filterDepartments(inputElement.value);
        }

        function clearFilter() {
            const inputElement = document.getElementById("departmentSearch");
            inputElement.value = "";
            filterDepartments("");
        }

        /**
         * 確実なフィルタリング処理（リスト再構築方式）
         */
        function filterDepartments(searchTerm) {
            const selectElement = document.getElementById("recipientUserIds");
            const input = searchTerm.toLowerCase().trim();

            // 1. 現在のリストを一度空にする
            selectElement.innerHTML = "";

            // 2. 保存しておいた全データ（allOptgroups）をチェックして、一致するものだけ追加する
            let matchCount = 0;

            allOptgroups.forEach(function(optgroup) {
                const label = optgroup.label.toLowerCase();

                // ★ポイント: 入力が空、または label に入力文字が含まれていれば追加
                if (input === "" || label.indexOf(input) !== -1) {
                    // クローンを作成して追加（元の保存データに影響を与えないため）
                    selectElement.appendChild(optgroup.cloneNode(true));
                    matchCount++;
                }
            });

            // 3. 検索結果が0件の場合のメッセージ用オプション（任意）
            if (matchCount === 0) {
                const noResultOption = document.createElement("option");
                noResultOption.text = "一致する学科が見つかりません";
                noResultOption.disabled = true;
                selectElement.appendChild(noResultOption);
            }
        }
    </script>

</body>
</html>
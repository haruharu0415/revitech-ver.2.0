<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>グループ作成・メンバー招待</title>
  <link th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    .selected-member {
      display: inline-block;
      padding: 5px 10px;
      margin: 5px;
      background-color: #0d6efd;
      color: white;
      border-radius: 20px;
      font-size: 0.9em;
    }
    .remove-btn {
      margin-left: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .search-results {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 5px 5px;
    }
    .search-results .list-group-item {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <main class="container p-3">
    <h1 class="mb-4">グループチャットの新規作成</h1>

    <form id="groupCreateForm" th:action="@{/chat-room/group/create}" method="post">
      <input type="hidden" name="creatorId" id="creatorId" th:value="${currentUserId}" /> 
      
      <div class="mb-3">
        <label for="groupName" class="form-label">グループ名</label>
        <input type="text" class="form-control" id="groupName" name="name" required placeholder="グループ名を入力" maxlength="50">
      </div>

      <div class="mb-3">
        <label class="form-label">メンバーの招待</label>
        
        <div id="selectedMembersContainer" class="p-2 border rounded mb-2" style="min-height: 40px;">
            </div>

        <div class="input-group">
          <input type="text" class="form-control" id="memberSearchInput" placeholder="名前またはメールアドレスでユーザーを検索">
          <button class="btn btn-secondary" type="button" id="searchButton">
            <i class="bi bi-search"></i> 検索
          </button>
        </div>
        
        <div id="searchResults" class="list-group search-results" style="display:none;">
          </div>

        <input type="hidden" name="memberIds" id="memberIds" required>
      </div>

      <button type="submit" class="btn btn-primary w-100">グループを作成</button>
      <a th:href="@{/chat-list}" class="btn btn-outline-secondary w-100 mt-2">キャンセル</a>
    </form>
  </main>

  <script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
  <script>
    const creatorId = document.getElementById('creatorId').value;
    const searchInput = document.getElementById('memberSearchInput');
    const searchButton = document.getElementById('searchButton');
    const searchResultsDiv = document.getElementById('searchResults');
    const selectedMembersContainer = document.getElementById('selectedMembersContainer');
    const memberIdsInput = document.getElementById('memberIds');
    const groupCreateForm = document.getElementById('groupCreateForm');

    // 既に選択されているメンバーIDのSet
    const selectedMemberIds = new Set([creatorId]); 
    const selectedMemberData = new Map(); 

    updateMemberIdsInput();

    function addSelectedMemberToUI(id, name) {
      if (!id || id === 'undefined') return;

      // 作成者本人はリストに表示しない
      if (id == creatorId) { 
          return; 
      }
      
      if (selectedMemberIds.has(String(id))) {
        return; 
      }
      
      selectedMemberIds.add(String(id));
      selectedMemberData.set(id, name);
      
      const tag = document.createElement('span');
      tag.className = 'selected-member';
      tag.setAttribute('data-id', id);
      tag.innerHTML = `
        ${name} 
        <span class="remove-btn" data-id="${id}"><i class="bi bi-x-circle-fill"></i></span>
      `;
      
      selectedMembersContainer.appendChild(tag);
      updateMemberIdsInput();
    }

    function updateMemberIdsInput() {
      const ids = Array.from(selectedMemberIds).filter(id => id && id !== 'undefined');
      memberIdsInput.value = ids.join(','); 
    }

    async function searchUsers() {
      const query = searchInput.value.trim();
      if (!query) {
        searchResultsDiv.style.display = 'none';
        return;
      }

      try {
        const response = await fetch(`/api/users/search?query=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error('ユーザー検索APIの呼び出しに失敗しました');
        const users = await response.json();
        renderSearchResults(users);
      } catch (error) {
        console.error('検索エラー:', error);
        searchResultsDiv.innerHTML = '<div class="list-group-item list-group-item-danger">検索中にエラーが発生しました。</div>';
        searchResultsDiv.style.display = 'block';
      }
    }

    function renderSearchResults(users) {
      searchResultsDiv.innerHTML = '';
      if (users.length === 0) {
        searchResultsDiv.innerHTML = '<div class="list-group-item">該当するユーザーはいません。</div>';
        searchResultsDiv.style.display = 'block';
        return;
      }
      
      users.forEach(user => {
        const userId = user.usersId; 

        if (String(userId) === creatorId || selectedMemberIds.has(String(userId))) {
          return;
        }

        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action';
        item.textContent = `${user.name} (${user.email})`;
        item.setAttribute('data-id', userId);
        item.setAttribute('data-name', user.name);
        
        item.addEventListener('click', (e) => {
          addSelectedMemberToUI(userId, user.name);
          searchResultsDiv.style.display = 'none'; 
          searchInput.value = ''; 
        });

        searchResultsDiv.appendChild(item);
      });

      searchResultsDiv.style.display = searchResultsDiv.children.length > 0 ? 'block' : 'none';
    }

    // イベントリスナー
    searchButton.addEventListener('click', searchUsers);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchUsers();
      }
    });

    selectedMembersContainer.addEventListener('click', (e) => {
      const removeBtn = e.target.closest('.remove-btn');
      if (removeBtn) {
        const idToRemove = removeBtn.getAttribute('data-id');
        
        selectedMemberIds.delete(idToRemove);
        selectedMemberData.delete(Number(idToRemove));

        const tagToRemove = removeBtn.closest('.selected-member');
        if (tagToRemove) {
          tagToRemove.remove();
        }
        
        updateMemberIdsInput();
      }
    });
    
    groupCreateForm.addEventListener('submit', (e) => {
        const memberCount = selectedMemberIds.size;
        if (memberCount < 2) {
            e.preventDefault();
            alert('グループには自分自身を含め、最低2名（他に1名以上）のメンバーが必要です。');
        }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>グループ作成・メンバー招待</title>
  <link th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    .selected-member {
      display: inline-block;
      padding: 5px 10px;
      margin: 5px;
      background-color: #0d6efd;
      color: white;
      border-radius: 20px;
      font-size: 0.9em;
    }
    .remove-btn {
      margin-left: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .search-results {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 5px 5px;
    }
    .search-results .list-group-item {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <main class="container p-3">
    <h1 class="mb-4">グループチャットの新規作成</h1>

    <form id="groupCreateForm" th:action="@{/chat-room/group/create}" method="post">
      <input type="hidden" name="creatorId" id="creatorId" value="1" /> 
      
      <div class="mb-3">
        <label for="groupName" class="form-label">グループ名</label>
        <input type="text" class="form-control" id="groupName" name="name" required placeholder="グループ名を入力" maxlength="50">
      </div>

      <div class="mb-3">
        <label class="form-label">メンバーの招待</label>
        
        <div id="selectedMembersContainer" class="p-2 border rounded mb-2">
            </div>

        <div class="input-group">
          <input type="text" class="form-control" id="memberSearchInput" placeholder="名前またはメールアドレスでユーザーを検索">
          <button class="btn btn-secondary" type="button" id="searchButton">
            <i class="bi bi-search"></i> 検索
          </button>
        </div>
        
        <div id="searchResults" class="list-group search-results" style="display:none;">
          </div>

        <input type="hidden" name="memberIds" id="memberIds" required>
      </div>

      <button type="submit" class="btn btn-primary w-100">グループを作成</button>
      <a th:href="@{/group}" class="btn btn-outline-secondary w-100 mt-2">キャンセル</a>
    </form>
  </main>

  <script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
  <script>
    const creatorId = document.getElementById('creatorId').value;
    const searchInput = document.getElementById('memberSearchInput');
    const searchButton = document.getElementById('searchButton');
    const searchResultsDiv = document.getElementById('searchResults');
    const selectedMembersContainer = document.getElementById('selectedMembersContainer');
    const memberIdsInput = document.getElementById('memberIds');
    const groupCreateForm = document.getElementById('groupCreateForm');

    // 既に選択されているメンバーIDのSet (重複防止用)
    const selectedMemberIds = new Set([creatorId]); 
    // 選択されたメンバーの表示用Map { id: name }
    const selectedMemberData = new Map(); 

    // 認証ユーザー(creator)を初期メンバーとして追加
    // 実際にはAPIで自分の名前を取得し、UIに追加しないが、ロジックとしてmemberIdsに追加する
    updateMemberIdsInput();

    /**
     * 選択されたメンバーをUIに追加する
     * @param {number} id - ユーザーID
     * @param {string} name - ユーザー名
     */
    function addSelectedMemberToUI(id, name) {
      if (id == creatorId) { // 作成者はUIに表示しない
          return; 
      }
      
      if (selectedMemberIds.has(String(id))) {
        return; // 既に選択済み
      }
      
      selectedMemberIds.add(String(id));
      selectedMemberData.set(id, name);
      
      const tag = document.createElement('span');
      tag.className = 'selected-member';
      tag.setAttribute('data-id', id);
      tag.innerHTML = `
        ${name} 
        <span class="remove-btn" data-id="${id}"><i class="bi bi-x-circle-fill"></i></span>
      `;
      
      selectedMembersContainer.appendChild(tag);
      updateMemberIdsInput();
    }

    /**
     * 選択されたメンバーIDをHiddenフィールドに設定する
     */
    function updateMemberIdsInput() {
      // Setに含まれる全てのID（作成者IDを含む）をカンマ区切りで設定
      memberIdsInput.value = Array.from(selectedMemberIds).join(','); 
    }

    /**
     * ユーザー検索APIの呼び出し
     */
    async function searchUsers() {
      const query = searchInput.value.trim();
      if (!query) {
        searchResultsDiv.style.display = 'none';
        return;
      }

      try {
        const response = await fetch(`/api/users/search?query=${encodeURIComponent(query)}`);
        if (!response.ok) {
          throw new Error('ユーザー検索APIの呼び出しに失敗しました');
        }
        const users = await response.json();
        renderSearchResults(users);
      } catch (error) {
        console.error('検索エラー:', error);
        searchResultsDiv.innerHTML = '<div class="list-group-item list-group-item-danger">検索中にエラーが発生しました。</div>';
        searchResultsDiv.style.display = 'block';
      }
    }

    /**
     * 検索結果をUIにレンダリングする
     * @param {Array<Object>} users - 検索結果のユーザーリスト
     */
    function renderSearchResults(users) {
      searchResultsDiv.innerHTML = '';
      if (users.length === 0) {
        searchResultsDiv.innerHTML = '<div class="list-group-item">該当するユーザーはいません。</div>';
        searchResultsDiv.style.display = 'block';
        return;
      }
      
      users.forEach(user => {
        // 自分自身、または既に選択されているユーザーは除外
        if (String(user.id) === creatorId || selectedMemberIds.has(String(user.id))) {
          return;
        }

        const item = document.createElement('div');
        item.className = 'list-group-item list-group-item-action';
        item.textContent = `${user.name} (${user.email})`;
        item.setAttribute('data-id', user.id);
        item.setAttribute('data-name', user.name);
        
        // クリックでメンバーに追加
        item.addEventListener('click', (e) => {
          addSelectedMemberToUI(user.id, user.name);
          searchResultsDiv.style.display = 'none'; // 選択後、検索結果を非表示
          searchInput.value = ''; // 検索窓をクリア
        });

        searchResultsDiv.appendChild(item);
      });

      searchResultsDiv.style.display = searchResultsDiv.children.length > 0 ? 'block' : 'none';
    }

    // --- イベントリスナー ---

    // 検索ボタンのクリック/Enterキーで検索を実行
    searchButton.addEventListener('click', searchUsers);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchUsers();
      }
    });

    // メンバー削除ボタンのクリック処理
    selectedMembersContainer.addEventListener('click', (e) => {
      const removeBtn = e.target.closest('.remove-btn');
      if (removeBtn) {
        const idToRemove = removeBtn.getAttribute('data-id');
        
        // SetからIDを削除
        selectedMemberIds.delete(idToRemove);
        selectedMemberData.delete(Number(idToRemove)); // Mapからも削除

        // UIからタグを削除
        const tagToRemove = removeBtn.closest('.selected-member');
        if (tagToRemove) {
          tagToRemove.remove();
        }
        
        updateMemberIdsInput();
      }
    });
    
    // フォーム送信時のチェック（グループ名とメンバー数の確認）
    groupCreateForm.addEventListener('submit', (e) => {
        const memberCount = selectedMemberIds.size;
        
        // グループ作成には最低2名 (作成者+1名) が必要
        if (memberCount < 2) {
            e.preventDefault();
            alert('グループには自分自身を含め、最低2名（他に1名以上）のメンバーが必要です。');
        }
    });

  </script>
</body>
</html>
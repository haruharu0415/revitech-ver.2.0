<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>グループ作成・メンバー招待</title>
  <link th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { padding-top: 1rem; padding-bottom: 1rem; background-color: #f8f9fa; }
    .container { max-width: 600px; background-color: #fff; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
    .selected-member { display: inline-flex; align-items: center; padding: 0.3rem 0.8rem; margin: 0.2rem; background-color: #e9ecef; color: #495057; border-radius: 1rem; font-size: 0.9em; border: 1px solid #ced4da; }
    .remove-btn { margin-left: 0.5rem; cursor: pointer; color: #dc3545; background: none; border: none; padding: 0; line-height: 1; font-size: 1.1em; }
    .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #ced4da; border-top: none; border-radius: 0 0 0.375rem 0.375rem; position: absolute; background-color: white; width: calc(100% - 2px); z-index: 10; }
    .search-results .list-group-item { cursor: pointer; padding: 0.5rem 1rem; }
    .search-results .list-group-item:hover { background-color: #f8f9fa; }
    #selectedMembersContainer { min-height: 50px; background-color: #f8f9fa; }
  </style>
</head>
<body>
  <main class="container">
    <h1 class="mb-4 text-center">グループチャットの新規作成</h1>

    <form id="groupCreateForm" th:action="@{/chat-room/group/create}" method="post">
      <div class="mb-3">
        <label for="groupName" class="form-label">グループ名</label>
        <input type="text" class="form-control" id="groupName" name="name" placeholder="グループ名を入力 (任意)" maxlength="50">
      </div>

      <div class="mb-4">
        <label class="form-label">メンバーの招待</label>
        <div id="selectedMembersContainer" class="p-2 border rounded mb-2">
            <span class="text-muted small">検索してメンバーを追加してください</span>
        </div>
        <div class="position-relative">
            <div class="input-group">
              <input type="text" class="form-control" id="memberSearchInput" placeholder="名前またはメールアドレスで検索">
              <button class="btn btn-outline-secondary" type="button" id="searchButton">
                <i class="bi bi-search"></i> 検索
              </button>
            </div>
            <div id="searchResults" class="list-group search-results" style="display:none;"></div>
        </div>
        <input type="hidden" name="memberIds" id="memberIds">
      </div>

      <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary">グループを作成</button>
          <a th:href="@{/group}" class="btn btn-outline-secondary">キャンセル</a>
      </div>
    </form>
  </main>

  <script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/ // ← 開始コメントはこれでOK
    // Controllerから渡されたログインユーザーIDを使用
    const authenticatedUserId = /*[[${userId}]]*/ null;

    if (!authenticatedUserId) {
        console.error("ログインユーザーIDが取得できませんでした。");
        document.querySelector('main.container').innerHTML = '<div class="alert alert-danger">エラー: ユーザー情報を取得できませんでした。ログインし直してください。</div><a href="/login" class="btn btn-primary">ログインページへ</a>';
    } else {
        const searchInput = document.getElementById('memberSearchInput');
        const searchButton = document.getElementById('searchButton');
        const searchResultsDiv = document.getElementById('searchResults');
        const selectedMembersContainer = document.getElementById('selectedMembersContainer');
        const memberIdsInput = document.getElementById('memberIds');
        const groupCreateForm = document.getElementById('groupCreateForm');

        const selectedMemberIds = new Set();
        const selectedMemberData = new Map();

        if (selectedMembersContainer.children.length === 0) {
            selectedMembersContainer.innerHTML = '<span class="text-muted small p-2">検索してメンバーを追加してください</span>';
        }
        updateMemberIdsInput();

        function addSelectedMemberToUI(id, name) {
            const userIdStr = String(id);
            if (userIdStr === String(authenticatedUserId) || selectedMemberIds.has(userIdStr)) return;
            selectedMemberIds.add(userIdStr);
            selectedMemberData.set(id, name);
            if (selectedMembersContainer.children.length === 1 && selectedMembersContainer.children[0].classList.contains('text-muted')) {
                selectedMembersContainer.innerHTML = '';
            }
            const tag = document.createElement('span');
            tag.className = 'selected-member';
            tag.setAttribute('data-id', id);
            tag.innerHTML = `
                ${name}
                <button type="button" class="remove-btn" data-id="${id}" aria-label="削除"><i class="bi bi-x-circle"></i></button>
            `;
            selectedMembersContainer.appendChild(tag);
            updateMemberIdsInput();
        }

        function updateMemberIdsInput() {
            memberIdsInput.value = Array.from(selectedMemberIds).join(',');
        }

        async function searchUsers() {
            const keyword = searchInput.value.trim();
            if (keyword.length < 1) {
                searchResultsDiv.style.display = 'none';
                return;
            }
            try {
                const response = await fetch(`/api/users/search?keyword=${encodeURIComponent(keyword)}`);
                if (!response.ok) throw new Error('ユーザー検索APIエラー');
                const users = await response.json();
                renderSearchResults(users);
            } catch (error) {
                console.error('検索エラー:', error);
                searchResultsDiv.innerHTML = '<div class="list-group-item list-group-item-light text-danger small">検索エラー</div>';
                searchResultsDiv.style.display = 'block';
            }
        }

        function renderSearchResults(users) {
            searchResultsDiv.innerHTML = '';
            let resultsFound = false;
            users.forEach(user => {
                const userIdStr = String(user.id);
                if (userIdStr === String(authenticatedUserId) || selectedMemberIds.has(userIdStr)) return;
                resultsFound = true;
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action py-2';
                item.textContent = `${user.name} (${user.email})`;
                item.setAttribute('data-id', user.id);
                item.setAttribute('data-name', user.name);
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    addSelectedMemberToUI(user.id, user.name);
                    searchResultsDiv.style.display = 'none';
                    searchInput.value = '';
                    searchInput.focus();
                });
                searchResultsDiv.appendChild(item);
            });
            if (!resultsFound) {
                 searchResultsDiv.innerHTML = '<div class="list-group-item list-group-item-light small">該当なし (自分自身と選択済みメンバーは表示されません)</div>';
            }
            searchResultsDiv.style.display = 'block';
        }

        searchButton.addEventListener('click', searchUsers);
        searchInput.addEventListener('input', searchUsers);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') e.preventDefault();
        });
        document.addEventListener('click', (e) => {
            if (!searchResultsDiv.contains(e.target) && e.target !== searchInput) {
                searchResultsDiv.style.display = 'none';
            }
        });
        selectedMembersContainer.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-btn');
            if (removeBtn) {
                const idToRemove = removeBtn.getAttribute('data-id');
                selectedMemberIds.delete(idToRemove);
                selectedMemberData.delete(Number(idToRemove));
                const tagToRemove = removeBtn.closest('.selected-member');
                if (tagToRemove) tagToRemove.remove();
                updateMemberIdsInput();
                if (selectedMembersContainer.children.length === 0) {
                     selectedMembersContainer.innerHTML = '<span class="text-muted small p-2">検索してメンバーを追加してください</span>';
                }
            }
        });
        groupCreateForm.addEventListener('submit', (e) => {
            const memberIdsArray = memberIdsInput.value ? memberIdsInput.value.split(',') : [];
            if (memberIdsArray.length < 1) {
                e.preventDefault();
                alert('招待するメンバーを1名以上選択してください。');
                searchInput.focus();
            }
        });
    }
    // ★★★ 終了コメントを修正 ★★★
    /*]]>*/
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>チャット一覧</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <th:block th:insert="~{header :: header-styles}"></th:block>
    <style>
        .chat-section-title {
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .dm-list-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        .group-card {
            transition: transform 0.2s;
            height: 100%;
        }
        .group-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        }
    </style>
</head>
<body class="bg-light">
    <div th:replace="~{header :: header-fragment}"></div>

    <main class="container-fluid px-4 py-4">
        
        <div class="row g-4">
            
            <div class="col-lg-3 col-md-4">
                <h4 class="chat-section-title"><i class="bi bi-person-lines-fill me-2"></i>個人チャット (DM)</h4>
                
                <div class="card shadow-sm border-0 dm-list-container">
                    <div class="list-group list-group-flush">
                        <a th:each="dm : ${dmList}" 
                           th:href="@{/chat/room/{id}(id=${dm.roomId})}" 
                           class="list-group-item list-group-item-action py-3 d-flex align-items-center">
                            <div class="me-3">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center border" style="width: 40px; height: 40px;">
                                    <i class="bi bi-person-fill fs-5 text-secondary"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="fw-bold text-truncate" th:text="${dm.partnerName}">相手の名前</div>
                                <small class="text-muted" style="font-size: 0.8rem;">チャットを開く</small>
                            </div>
                            <i class="bi bi-chevron-right text-muted small"></i>
                        </a>

                        <div th:if="${dmList == null or dmList.isEmpty()}" class="text-center py-5 text-muted">
                            <i class="bi bi-chat-square mb-2 d-block fs-4"></i>
                            <small>履歴はありません</small><br />
                            <a th:href="@{/user-search}" class="btn btn-sm btn-outline-primary mt-3 rounded-pill">ユーザーを探す</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9 col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="chat-section-title mb-0 border-0 pb-0"><i class="bi bi-people-fill me-2"></i>グループチャット</h4>
                    
                    <form th:action="@{/group/change-sort}" method="post" class="d-inline-block">
                        <div class="input-group input-group-sm">
                            <label class="input-group-text bg-white" for="sortOrder"><i class="bi bi-sort-down"></i></label>
                            <select class="form-select" id="sortOrder" name="sortOrder" onchange="this.form.submit()">
                                <option value="1" th:selected="${user.chatSortOrder == 1}">最近使った順</option>
                                <option value="2" th:selected="${user.chatSortOrder == 2}">名前順</option>
                            </select>
                        </div>
                    </form>
                </div>

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body py-3">
                        <form th:action="@{/group/list}" method="get" class="d-flex gap-2">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                                <input type="text" name="keyword" class="form-control border-start-0" 
                                       th:value="${keyword}"
                                       th:placeholder="${user.role == 1} ? 'グループ名で検索...' : 'グループ名、メンバー名で検索...'" 
                                       aria-label="検索">
                            </div>
                            <button type="submit" class="btn btn-primary px-4">検索</button>
                            <div th:if="${keyword != null}">
                                <a th:href="@{/group/list}" class="btn btn-outline-secondary">クリア</a>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-xl-4 col-lg-6" th:each="group : ${groups}">
                        <div class="card h-100 shadow-sm border-0 group-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="card-title fw-bold text-dark mb-1" th:text="${group.name}">グループ名</h5>
                                        <span class="badge bg-light text-secondary border">グループ</span>
                                    </div>
                                    <i class="bi bi-people fs-3 text-primary opacity-50"></i>
                                </div>
                                
                                <p class="card-text text-muted small mb-4">
                                    メンバーと情報を共有しましょう。
                                </p>
                                
                                <div class="d-grid gap-2">
                                    <a th:href="@{/group/chat/{id}(id=${group.roomId})}" class="btn btn-primary">
                                        <i class="bi bi-chat-fill me-1"></i>チャットに参加
                                    </a>

                                    <div th:if="${user != null and (user.role == 2 or user.role == 3)}">
                                        <a th:href="@{/group/manage/{id}(id=${group.roomId})}" class="btn btn-outline-secondary w-100">
                                            <i class="bi bi-gear-fill me-1"></i>管理
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(groups)}" class="alert alert-light text-center py-5 shadow-sm mt-3">
                    <i class="bi bi-search fs-1 text-muted mb-3 d-block"></i>
                    <p class="mb-0" th:text="${keyword != null} ? '条件に一致するグループは見つかりませんでした。' : '現在、参加可能なグループはありません。'"></p>
                </div>
            </div>
            
        </div>
        
        <div class="mt-5 text-center">
            <a th:href="@{/home}" class="text-decoration-none text-secondary">
                <i class="bi bi-arrow-left me-1"></i>ホームに戻る
            </a>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
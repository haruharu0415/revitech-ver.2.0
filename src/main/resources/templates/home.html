<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ホーム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <th:block th:insert="~{header :: header-styles}"></th:block>
    <style>
        .main-content { padding: 1rem; }
        .simple-carousel-container {
            border: 1px solid #eee; padding: 0; margin-bottom: 1.5rem;
            border-radius: 0.5rem; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); 
            background-color: #ffffff; overflow: hidden;
        }
        .simple-carousel-item { min-height: 90px; display: flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; font-size: 0.95rem; color: #333; text-align: center; }
        .simple-carousel-item p { margin-bottom: 0; }
        .carousel-control-prev-icon, .carousel-control-next-icon { background-color: #212529; border-radius: 50%; padding: 10px; background-size: 50% 50%; }
        .carousel-control-prev, .carousel-control-next { width: 10%; }
        .carousel-title { font-size: 1.1rem; font-weight: 600; color: #212529; padding: 0.75rem 0; background-color: #ffffff; border-bottom: 1px solid #eee; border-radius: 0.5rem 0.5rem 0 0; margin-bottom: 0; }
        .simple-carousel-item-link { text-decoration: none; color: inherit; display: block; }
        .news-date { font-size: 0.8rem; color: #6c757d; display: block; margin-top: 5px; }
        .list-group-item { transition: background-color 0.2s; }
        .list-group-item:hover { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div th:replace="~{header :: header-fragment}"></div>

    <main class="main-content container">

        <div class="modal fade" id="adminNotificationModal" tabindex="-1" aria-hidden="true" th:if="${pendingCount}">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title fw-bold"><i class="bi bi-person-plus-fill me-2"></i>アカウント承認待ち</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="fs-5">現在 <span class="fw-bold text-danger" th:text="${pendingCount}"></span> 件の<br>教員アカウント承認申請があります。</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <a th:href="@{/admin/approvals}" class="btn btn-primary">確認画面へ</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="adminDisclosureModal" tabindex="-1" aria-hidden="true" th:if="${disclosureCount}">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title fw-bold"><i class="bi bi-shield-lock-fill me-2"></i>開示請求の通知</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="fs-5">現在 <span class="fw-bold text-danger" th:text="${disclosureCount}"></span> 件の<br>情報開示請求が届いています。</p>
                        <p class="small text-muted">内容を確認し、承認または却下を行ってください。</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <a th:href="@{/disclosure/list}" class="btn btn-danger">請求リストへ</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="teacherGrantedModal" tabindex="-1" aria-hidden="true" th:if="${grantedCount}">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title fw-bold"><i class="bi bi-check-circle-fill me-2"></i>開示請求の許可</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="fs-5"><span class="fw-bold" th:text="${grantedCount}"></span> 件の開示請求が許可されました。</p>
                        <p class="small text-muted">申請した情報の閲覧が可能です。</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <a th:href="@{/disclosure/list}" class="btn btn-success">確認する</a>
                    </div>
                </div>
            </div>
        </div>


        <div th:if="${user != null and user.role == 3 and disclosureRequests != null and !disclosureRequests.isEmpty()}" class="alert alert-warning shadow-sm mb-4">
            <h5 class="alert-heading fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>開示請求が届いています</h5>
            <div class="list-group list-group-flush mt-2 bg-white rounded">
                <a th:each="req : ${disclosureRequests}" 
                   th:href="@{/review/{id}(id=${req.teacherId})}" 
                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <span>
                        <span class="badge bg-danger me-2">請求中</span>
                        コメントID: <span th:text="${req.reviewId}">1</span> の開示請求
                    </span>
                    <small class="text-muted">確認する <i class="bi bi-chevron-right"></i></small>
                </a>
            </div>
        </div>

        <div th:if="${user != null and user.role == 2 and grantedDisclosures != null and !grantedDisclosures.isEmpty()}" class="alert alert-danger shadow-sm mb-4">
            <h5 class="alert-heading fw-bold"><i class="bi bi-unlock-fill me-2"></i>情報開示が許可されました</h5>
            <div class="list-group list-group-flush mt-2 bg-white rounded">
                <a th:each="grant : ${grantedDisclosures}" 
                   th:href="@{/review/disclosure-info/{id}(id=${grant.reviewId})}" 
                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <span>
                        <span class="badge bg-success me-2">開示済み</span>
                        コメントID: <span th:text="${grant.reviewId}">1</span> の情報閲覧
                    </span>
                    <small class="text-muted">詳細を見る <i class="bi bi-chevron-right"></i></small>
                </a>
            </div>
        </div>

        <div th:if="${carouselNews != null && !carouselNews.isEmpty()}" id="announcementCarousel" class="carousel slide simple-carousel-container" data-bs-ride="carousel" data-bs-interval="5000">
            <h4 class="text-center carousel-title">学校からのお知らせ</h4>
            <div class="carousel-inner">
                <div th:each="news, stat : ${carouselNews}" class="carousel-item" th:classappend="${stat.first} ? 'active'">
                    <a th:href="@{/news/{id}(id=${news.newsId})}" class="d-block w-100 simple-carousel-item-link">
                        <div class="d-block w-100 simple-carousel-item">
                            <p>
                                <strong th:if="${stat.first}" class="text-danger">【NEW】</strong>
                                <strong th:text="${news.title}">タイトル</strong>
                                <br>
                                <span class="news-date" th:text="${#temporals.format(news.newsDatetime, 'yyyy/MM/dd HH:mm')}">日時</span>
                            </p>
                        </div>
                    </a>
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#announcementCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">前へ</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#announcementCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">次へ</span>
            </button>
        </div>

        <div th:if="${carouselNews == null || carouselNews.isEmpty()}" class="carousel slide simple-carousel-container d-flex align-items-center justify-content-center">
            <p class="text-muted m-0 p-4">現在、新しいお知らせはありません。</p>
        </div>
        
        <div class="row justify-content-center mb-5 g-3">
            <div class="col-6 col-md-4 d-grid">
                <a th:href="@{/news}" class="btn btn-outline-primary py-3">
                    <i class="bi bi-bell-fill d-block mb-1 fs-5"></i> お知らせ
                </a>
            </div>
            <div class="col-6 col-md-4 d-grid" th:if="${user != null and user.role == 1}">
                <a th:href="@{/student/survey/list}" class="btn btn-outline-success py-3">
                    <i class="bi bi-clipboard-check d-block mb-1 fs-5"></i> アンケート回答
                </a>
            </div>
            <div class="col-6 col-md-4 d-grid" th:if="${user != null and (user.role == 2 or user.role == 3)}">
                <a th:href="@{/teacher/survey/create}" class="btn btn-outline-warning py-3 text-dark">
                    <i class="bi bi-clipboard-plus d-block mb-1 fs-5"></i> アンケート作成
                </a>
            </div>
            <div class="col-6 col-md-4 d-grid">
                <a th:href="@{/teacher-list}" class="btn btn-outline-secondary py-3">
                    <i class="bi bi-person-video3 d-block mb-1 fs-5"></i> 教員一覧
                </a>
            </div>
            <div class="col-6 col-md-4 d-grid">
                <a th:href="@{/group/list}" class="btn btn-outline-secondary py-3">
                    <i class="bi bi-chat-dots-fill d-block mb-1 fs-5"></i> チャット一覧
                </a>
            </div>
            <div class="col-6 col-md-4 d-grid">
                <a th:href="@{/user-search}" class="btn btn-outline-secondary py-3">
                    <i class="bi bi-search d-block mb-1 fs-5"></i> DM検索
                </a>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card shadow-sm h-100 border-0">
                    <div class="card-header bg-white fw-bold border-bottom-0 pt-3">
                        <i class="bi bi-people-fill text-success me-2"></i>通知が来ているグループ
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            <a th:each="group : ${unreadGroups}" 
                               th:href="@{/chat/room/{id}(id=${group.roomId})}" 
                               class="list-group-item list-group-item-action border-0 px-4 py-3 d-flex justify-content-between align-items-center">
                                <span th:text="${group.name}">グループ名</span>
                                <span class="badge bg-danger rounded-pill">!</span>
                            </a>
                            <div th:if="${#lists.isEmpty(unreadGroups)}" class="text-center py-4 text-muted">
                                <small>通知はありません</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm h-100 border-0">
                    <div class="card-header bg-white fw-bold border-bottom-0 pt-3">
                        <i class="bi bi-envelope-fill text-warning me-2"></i>未読のDM
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            <a th:each="dm : ${unreadDms}" 
                               th:href="@{/chat/room/{id}(id=${dm.roomId})}" 
                               class="list-group-item list-group-item-action border-0 px-4 py-3 d-flex justify-content-between align-items-center">
                                <span th:text="${dm.name}">相手の名前</span>
                                <span class="badge bg-primary rounded-pill">New</span>
                            </a>
                            <div th:if="${#lists.isEmpty(unreadDms)}" class="text-center py-4 text-muted">
                                <small>未読メッセージはありません</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 画面上にウィンドウの要素が存在するかどうかで判定します
            
            // 1. アカウント承認待ちウィンドウ
            var adminModalEl = document.getElementById('adminNotificationModal');
            if (adminModalEl) {
                var adminModal = new bootstrap.Modal(adminModalEl);
                adminModal.show();
            }
            
            // 2. 開示請求ウィンドウ
            var disclosureModalEl = document.getElementById('adminDisclosureModal');
            if (disclosureModalEl) {
                var disclosureModal = new bootstrap.Modal(disclosureModalEl);
                disclosureModal.show();
            }

            // 3. 開示許可ウィンドウ
            var teacherModalEl = document.getElementById('teacherGrantedModal');
            if (teacherModalEl) {
                var teacherModal = new bootstrap.Modal(teacherModalEl);
                teacherModal.show();
            }
        });
    </script>
</body>
</html>
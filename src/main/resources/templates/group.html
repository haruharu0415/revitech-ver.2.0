<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>グループチャット</title>
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
      body { 
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
          background-color: #f0f2f5; 
          margin: 0; 
          padding: 0; 
          display: flex; 
          flex-direction: column; 
          height: 100vh; 
      }
      
      header { 
          background: #075e54; 
          color: white; 
          padding: 15px 20px; 
          font-size: 1.25rem; 
          font-weight: bold; 
          display: flex; 
          align-items: center; 
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          z-index: 10;
      }
      
      .back-link {
          color: white;
          text-decoration: none;
          margin-right: 15px;
          display: flex;
          align-items: center;
          transition: opacity 0.2s;
      }
      .back-link:hover {
          opacity: 0.8;
          color: white;
      }

      /* コンテンツエリア (スクロール可能) */
      .content-area {
          flex-grow: 1;
          overflow-y: auto;
          padding: 20px;
      }

      /* --- カードデザインの変更 --- */
      .group-card {
          background: white;
          border: none;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          transition: transform 0.2s, box-shadow 0.2s;
          cursor: pointer;
          height: 100%; /* 高さを揃える */
          position: relative;
          overflow: hidden;
      }
      .group-card:hover {
          transform: translateY(-3px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.12);
      }

      /* カード上部の色帯 */
      .card-top-bar {
          height: 6px;
          background: linear-gradient(90deg, #25d366, #128c7e);
          width: 100%;
      }

      .card-body-custom {
          padding: 20px;
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
      }

      .group-avatar {
          width: 70px;
          height: 70px;
          background-color: #e9f7ef;
          color: #075e54;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 28px;
          font-weight: bold;
          margin-bottom: 15px;
          border: 2px solid #fff;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }

      .group-name {
          font-weight: 700;
          font-size: 1.1rem;
          color: #333;
          margin-bottom: 5px;
          line-height: 1.3;
          /* 長い名前は省略 */
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
      }

      .last-active {
          font-size: 0.8rem;
          color: #888;
      }

      /* 未読バッジ (カードの右上に配置) */
      .notification-badge {
          position: absolute;
          top: 15px;
          right: 15px;
          background-color: #ff3b30;
          color: white;
          border-radius: 50%;
          min-width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          font-weight: bold;
          padding: 4px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          z-index: 2;
      }

      /* 削除ボタン (カードの右下に配置) */
      .delete-btn {
          position: absolute;
          bottom: 10px;
          right: 10px;
          color: #ccc;
          padding: 8px;
          font-size: 1.1rem;
          transition: color 0.2s;
          z-index: 5;
      }
      .delete-btn:hover {
          color: #dc3545;
          background-color: rgba(220, 53, 69, 0.1);
          border-radius: 50%;
      }

      /* フローティングアクションボタン */
      .fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background-color: #075e54; /* ヘッダーと色を合わせる */
        color: white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        text-decoration: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;
        transition: transform 0.2s;
      }
      .fab:hover {
          transform: scale(1.05);
          color: white;
      }
    </style>
</head>
<body>

    <!-- CSRFトークン -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <header>
      <a href="/home" class="back-link">
          <i class="bi bi-arrow-left"></i>
      </a>
      <span>参加中のグループ</span>
    </header>

    <div class="content-area container-fluid">
        <!-- グリッドレイアウト用の行 -->
        <div id="chatRoomList" class="row g-3">
            <!-- ここにJSでカードが挿入されます -->
        </div>
    </div>
    
    <!-- 作成ボタン -->
    <a href="/group-create" class="fab" title="新規グループ作成">
        <i class="bi bi-plus-lg"></i>
    </a>

    <script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      const canManageGroup = /*[[${canManageGroup}]]*/ false;
      const csrfToken = document.querySelector('meta[name="_csrf"]').content;
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

      async function fetchChatRooms() {
        const chatRoomList = document.getElementById('chatRoomList');
        
        try {
          const response = await fetch('/api/chat-rooms/my-rooms');
          
          if (!response.ok) {
            if (response.status === 401) {
              throw new Error('認証エラー');
            }
            throw new Error(`エラー: ${response.status}`);
          }

          const allRooms = await response.json();
          // グループチャットのみを抽出 (type=2)
          const rooms = allRooms.filter(r => r.type === 2);
          
          if (rooms.length === 0) {
             chatRoomList.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-people display-4 text-secondary mb-3 d-block"></i>
                    <p class="text-muted">参加しているグループはありません。<br>右下のボタンから作成してみましょう。</p>
                </div>`;
             return;
          }

          rooms.sort((a, b) => {
            const timeA = a.lastMessageTimestamp ? new Date(a.lastMessageTimestamp) : new Date(0);
            const timeB = b.lastMessageTimestamp ? new Date(b.lastMessageTimestamp) : new Date(0);
            return timeB - timeA;
          });

          rooms.forEach(room => {
            // カラム要素 (スマホ:2列, タブレット:3列, PC:4列)
            const col = document.createElement('div');
            col.className = 'col-6 col-md-4 col-lg-3';

            // カード要素
            const card = document.createElement('div');
            card.className = 'group-card';
            
            // 色帯
            const topBar = document.createElement('div');
            topBar.className = 'card-top-bar';
            card.appendChild(topBar);

            // カードの中身
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body-custom';

            // アイコン
            const avatar = document.createElement('div');
            avatar.className = 'group-avatar';
            avatar.textContent = room.name ? room.name[0].toUpperCase() : 'G';
            cardBody.appendChild(avatar);

            // グループ名
            const name = document.createElement('div');
            name.className = 'group-name';
            name.textContent = room.name || '名称未設定';
            cardBody.appendChild(name);

            // 最終更新日時
            const lastActive = document.createElement('div');
            lastActive.className = 'last-active';
            if (room.lastMessageTimestamp) {
                const date = new Date(room.lastMessageTimestamp);
                lastActive.textContent = date.toLocaleDateString();
            } else {
                lastActive.textContent = '新規';
            }
            cardBody.appendChild(lastActive);

            card.appendChild(cardBody);

            // 未読バッジ
            if (room.unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'notification-badge';
                badge.textContent = room.unreadCount > 99 ? '99+' : room.unreadCount;
                card.appendChild(badge);
            }

            // 削除ボタン (権限がある場合)
            if (canManageGroup) {
                const delBtn = document.createElement('div');
                delBtn.className = 'delete-btn';
                delBtn.innerHTML = '<i class="bi bi-trash"></i>';
                delBtn.title = "削除する";
                
                delBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (!confirm(`グループ「${room.name}」を削除しますか？\nメッセージも全て消えます。`)) {
                        return;
                    }
                    try {
                        const delRes = await fetch(`/chat-room/delete/${room.roomId}`, { 
                            method: 'POST',
                            headers: { [csrfHeader]: csrfToken }
                        });
                        if (delRes.ok || delRes.redirected) {
                            window.location.reload();
                        } else {
                            alert('削除に失敗しました。');
                        }
                    } catch (err) {
                        console.error(err);
                    }
                };
                card.appendChild(delBtn);
            }

            // クリックでチャットへ
            card.addEventListener('click', () => {
              window.location.href = `/chat/room/${room.roomId}`;
            });

            col.appendChild(card);
            chatRoomList.appendChild(col);
          });

        } catch (error) {
          console.error(error);
          chatRoomList.innerHTML = `<p class="text-danger text-center p-4">読み込みエラー: ${error.message}</p>`;
        }
      }

      document.addEventListener('DOMContentLoaded', fetchChatRooms);
      /*]]>*/
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>グループチャット</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#e5ddd5; margin:0; padding:0; display:flex; flex-direction:column; height: 100vh; }
      header { background:#075e54; color:white; padding:15px; font-size:20px; font-weight:bold; display:flex; align-items:center; justify-content:space-between; }
      header a { color:white; text-decoration: none; margin-right: 15px; }
      #chatRoomList { flex-grow:1; overflow-y:auto; padding:10px; }
      /* バッジを絶対配置するために relative を追加 */
      .chat-room { background:white; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; padding:10px; box-shadow:0 2px 3px rgba(0,0,0,0.1); cursor:pointer; position: relative; }
      .avatar { width:50px; height:50px; background:#25d366; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:20px; margin-right:15px; user-select:none; flex-shrink: 0; }
      .chat-info { flex-grow:1; overflow: hidden; }
      .chat-name { font-weight:600; font-size:16px; color:#111; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .chat-type { font-size:12px; color:#888; }
      
      /* 未読通知バッジのスタイル */
      .notification-badge {
          background-color: #ff3b30;
          color: white;
          border-radius: 50%;
          padding: 0.25em 0.6em;
          font-size: 0.75rem;
          font-weight: bold;
          position: absolute;
          right: 15px;
          top: 50%;
          transform: translateY(-50%);
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .create-group-btn {
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background-color: #25d366;
          color: white;
          font-size: 30px;
          border: none;
          box-shadow: 0 4px 8px rgba(0,0,0,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          text-decoration: none;
          z-index: 1000;
      }
      .create-group-btn:hover { background-color: #20b85c; color: white; }
    </style>
</head>
<body>

    <header>
        <div class="d-flex align-items-center">
            <a href="/home"><i class="bi bi-arrow-left"></i></a>
            <span>チャット一覧</span>
        </div>
    </header>

    <div id="chatRoomList">
      <div class="text-center mt-5">
          <div class="spinner-border text-secondary" role="status">
              <span class="visually-hidden">Loading...</span>
          </div>
      </div>
    </div>

    <a href="/group-create" class="create-group-btn">
        <i class="bi bi-plus"></i>
    </a>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const chatRoomList = document.getElementById('chatRoomList');

        try {
          // ★★★ APIからルーム一覧を取得 ★★★
          const response = await fetch('/api/chat-rooms/my-rooms');
          if (!response.ok) throw new Error('データ取得エラー');
          const rooms = await response.json();

          chatRoomList.innerHTML = ''; // ローディング表示をクリア

          if (rooms.length === 0) {
              chatRoomList.innerHTML = '<p class="text-center text-muted mt-4">参加しているチャットルームはありません。</p>';
              return;
          }

          rooms.forEach(room => {
            const div = document.createElement('div');
            div.className = 'chat-room';

            // アイコン
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            // ルーム名の頭文字を表示（なければ'?'）
            avatar.textContent = (room.name && room.name.length > 0) ? room.name.charAt(0) : '?';
            div.appendChild(avatar);

            // 情報エリア
            const info = document.createElement('div');
            info.className = 'chat-info';
            
            const name = document.createElement('div');
            name.className = 'chat-name';
            name.textContent = room.name || '名称未設定';
            info.appendChild(name);
            
            const type = document.createElement('div');
            type.className = 'chat-type';
            // typeは 1:DM, 2:Group と想定
            type.textContent = room.type === 1 ? 'ダイレクトメッセージ' : 'グループチャット';
            info.appendChild(type);
            
            div.appendChild(info);

            // --- 未読件数 > 0 なら通知バッジを追加 ---
            if (room.unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'notification-badge';
                badge.textContent = room.unreadCount > 9 ? '9+' : room.unreadCount;
                div.appendChild(badge);
            }

            // クリックイベント
            div.addEventListener('click', () => {
              // ★★★ 修正: room.id ではなく room.roomId を使用 ★★★
              window.location.href = `/chat/room/${room.roomId}`;
            });

            chatRoomList.appendChild(div);
          });

        } catch (error) {
          console.error('Fetch Error:', error);
          chatRoomList.innerHTML = `<p class="text-danger text-center mt-4">読み込みに失敗しました: ${error.message}</p>`;
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
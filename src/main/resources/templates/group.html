<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>グループチャット</title>
    <link th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#e5ddd5; margin:0; padding:0; display:flex; flex-direction:column; min-height: 100vh; }
      header { background:#075e54; color:white; padding:15px; font-size:1.25rem; font-weight:bold; flex-shrink: 0; }
      #chatRoomList { flex-grow:1; overflow-y:auto; padding:10px; }
      .chat-room { background:white; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; padding:10px; box-shadow:0 1px 2px rgba(0,0,0,0.1); cursor:pointer; position: relative; transition: background-color 0.2s ease; }
      .chat-room:hover { background-color: #f0f0f0; }
      .avatar { width:50px; height:50px; background:#25d366; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:1.25rem; margin-right:15px; user-select:none; flex-shrink: 0; }
      .chat-info { flex-grow:1; overflow: hidden; /* Prevent text overflow */ }
      .chat-name { font-weight:600; font-size:1rem; color:#111; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .chat-type { font-size:0.8rem; color:#666; margin-top:2px; }
      #createGroupBtn { position:fixed; bottom:25px; right:25px; width:56px; height:56px; background:#25d366; border-radius:50%; border:none; color:white; font-size:2rem; font-weight:bold; cursor:pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
      .notification-badge { position: absolute; top: 12px; right: 12px; background-color: #f44336; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; justify-content: center; align-items: center; font-weight: bold; line-height: 1; }
      .empty-list-message { text-align: center; color: #666; padding: 30px 15px; }
    </style>
</head>
<body>
    <header>グループチャットルーム</header>
    <div id="chatRoomList">
        <p class="empty-list-message">ルームを読み込んでいます...</p>
    </div>
    <button id="createGroupBtn" aria-label="グループを作成">＋</button>

    <script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const chatRoomList = document.getElementById('chatRoomList');
        const createGroupBtn = document.getElementById('createGroupBtn');

        function getAvatarText(name){ return name ? name.charAt(0).toUpperCase() : "?"; }

        try {
          // ★ /api/rooms から DTO のリストを取得
          const response = await fetch('/api/rooms'); 
          if (!response.ok) throw new Error('ルームリストの取得に失敗しました。');
          let rooms = await response.json(); // ★ DTOのリスト
          chatRoomList.innerHTML = ''; // クリア

          if (rooms.length === 0) {
              chatRoomList.innerHTML = '<p class="empty-list-message">参加しているグループチャットはありません。</p>';
          } else {
              
              // ★★★ 修正点 1: DTOの未読件数と最終時刻でソート ★★★
              rooms.sort((a, b) => {
                  // null チェックを追加
                  const unreadA = a.unreadCount || 0;
                  const unreadB = b.unreadCount || 0;
                  
                  if (unreadA > 0 && unreadB === 0) return -1;
                  if (unreadB > 0 && unreadA === 0) return 1;
                  
                  const timeA = a.lastMessageTimestamp ? new Date(a.lastMessageTimestamp) : new Date(0);
                  const timeB = b.lastMessageTimestamp ? new Date(b.lastMessageTimestamp) : new Date(0);
                  return timeB - timeA; // 最終メッセージ時刻で降順
              });

              // リスト描画
              rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = 'chat-room';

                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.textContent = getAvatarText(room.name);
                div.appendChild(avatar);

                const info = document.createElement('div');
                info.className = 'chat-info';
                const name = document.createElement('div');
                name.className = 'chat-name';
                name.textContent = room.name || 'DM'; 
                info.appendChild(name);

                const type = document.createElement('div');
                type.className = 'chat-type';
                type.textContent = room.type === 1 ? 'ダイレクトメッセージ' : (room.type === 2 ? 'グループチャット' : '不明');
                info.appendChild(type);
                div.appendChild(info);

                // ★★★ 修正点 2: 未読バッジ (通知機能) を復活 ★★★
                if (room.unreadCount > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = room.unreadCount > 9 ? '9+' : room.unreadCount;
                    div.appendChild(badge);
                }

                // ★ room.id は DTO の id (Long)
                div.addEventListener('click', () => { window.location.href = `/chat/room/${room.id}`; });
                chatRoomList.appendChild(div);
              });
          }

        } catch (error) {
            console.error('Fetch Error:', error);
            chatRoomList.innerHTML = `<p class="alert alert-danger mx-3">${error.message}</p>`;
        }

        // グループ作成ボタン
        createGroupBtn.addEventListener('click', () => { window.location.href = '/group-create'; });
      });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>グループチャット</title>
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#e5ddd5; margin:0; padding:0; display:flex; flex-direction:column; }
      header { background:#075e54; color:white; padding:15px; font-size:20px; font-weight:bold; }
      #chatRoomList { flex-grow:1; overflow-y:auto; padding:10px; }
      /* バッジを絶対配置するために relative を追加 */
      .chat-room { background:white; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; padding:10px; box-shadow:0 2px 3px rgba(0,0,0,0.1); cursor:pointer; position: relative; }
      .avatar { width:50px; height:50px; background:#25d366; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:20px; margin-right:15px; user-select:none; }
      .chat-info { flex-grow:1; }
      .chat-name { font-weight:600; font-size:16px; color:#111; }
      .chat-type { font-size:14px; color:#555; }
      
      /* フローティングボタン */
      .fab {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background-color: #25d366;
        color: white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 1000;
      }
      
      /* --- 未読通知バッジのスタイル --- */
      .notification-badge {
        position: absolute;
        top: 10px; /* 位置を調整 */
        right: 15px; /* 位置を調整 */
        background-color: #f44336; /* 赤色 */
        color: white;
        border-radius: 50%;
        min-width: 24px; /* 最小幅 */
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: bold;
        padding: 2px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      }
      /* --- スタイル追加ここまで --- */
      
    </style>
</head>
<body>

    <header>
      グループ一覧
    </header>

    <div id="chatRoomList">
      </div>
    
    <a href="/group-create" class="fab">+</a>

    <script>
      async function fetchChatRooms() {
        const chatRoomList = document.getElementById('chatRoomList');
        
        try {
          // ※ APIエンドポイントは /api/chat-rooms/my-rooms であると仮定しています
          const response = await fetch('/api/chat-rooms/my-rooms');
          
          if (!response.ok) {
            if (response.status === 401) {
              throw new Error('認証に失敗しました。再ログインしてください。');
            }
            throw new Error(`サーバーエラー: ${response.statusText} (${response.status})`);
          }

          const rooms = await response.json();
          
          if (rooms.length === 0) {
             chatRoomList.innerHTML = '<p style="text-align: center; padding: 20px; color: #555;">参加しているグループチャットやDMはありません。</p>';
             return;
          }

          // 最終メッセージ時刻で降順ソート
          rooms.sort((a, b) => {
            const timeA = a.lastMessageTimestamp ? new Date(a.lastMessageTimestamp) : new Date(0);
            const timeB = b.lastMessageTimestamp ? new Date(b.lastMessageTimestamp) : new Date(0);
            return timeB - timeA;
          });

          rooms.forEach(room => {
            const div = document.createElement('div');
            div.className = 'chat-room';
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = room.name ? room.name[0].toUpperCase() : 'D'; // 頭文字
            div.appendChild(avatar);
            
            const info = document.createElement('div');
            info.className = 'chat-info';
            const name = document.createElement('div');
            name.className = 'chat-name';
            name.textContent = room.name || 'DM'; // 名前がなければ 'DM' と表示
            info.appendChild(name);
            const type = document.createElement('div');
            type.className = 'chat-type';
            // ※ DTOの `type` が 1=DM, 2=GROUP の前提
            type.textContent = room.type === 1 ? 'ダイレクトメッセージ' : 'グループチャット';
            info.appendChild(type);
            div.appendChild(info);

            // --- 未読件数 > 0 なら通知バッジを追加 ---
            if (room.unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'notification-badge';
                // 9件より多い場合は '9+' と表示
                badge.textContent = room.unreadCount > 9 ? '9+' : room.unreadCount;
                div.appendChild(badge);
            }
            // --- バッジ追加ここまで ---

            // クリックイベント
            div.addEventListener('click', () => {
              // ★★★ エラー修正箇所 ★★★
              // room.id を room.roomId に修正
              window.location.href = `/chat/room/${room.roomId}`;
            });

            chatRoomList.appendChild(div);
          });

        } catch (error) {
          console.error('Fetch Error:', error);
          // エラーメッセージを表示
          chatRoomList.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">${error.message}</p>`;
        }
      }

      document.addEventListener('DOMContentLoaded', fetchChatRooms);
    </script>
</body>
</html>
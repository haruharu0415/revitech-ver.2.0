<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>グループチャット</title>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#e5ddd5; margin:0; padding:0; display:flex; flex-direction:column; }
  header { background:#075e54; color:white; padding:15px; font-size:20px; font-weight:bold; }
  #chatRoomList { flex-grow:1; overflow-y:auto; padding:10px; }
  .chat-room { background:white; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; padding:10px; box-shadow:0 2px 3px rgba(0,0,0,0.1); cursor:pointer; }
  .avatar { width:50px; height:50px; background:#25d366; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:20px; margin-right:15px; user-select:none; }
  .chat-info { flex-grow:1; }
  .chat-name { font-weight:600; font-size:16px; color:#111; }
  .chat-type { font-size:12px; color:#666; margin-top:3px; }
  #createGroupBtn { position:fixed; bottom:30px; right:30px; width:60px; height:60px; background:#25d366; border-radius:50%; border:none; color:white; font-size:30px; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>
<header>グループチャットルーム</header>
<div id="chatRoomList"></div>
<button id="createGroupBtn">＋</button>

<script>
  // 【TODO】認証ユーザーIDをThymeleafなどで設定することを想定
  const myId = 1; 
  const chatRoomList = document.getElementById('chatRoomList');
  const createGroupBtn = document.getElementById('createGroupBtn');

  // アバターのテキストを生成
  function getAvatarText(name){ return name ? name.charAt(0).toUpperCase() : "?"; }

  // チャットルーム一覧を取得
  async function fetchChatRooms(){
    // 【TODO】実際にはログインユーザーに紐づくルームのみを取得するAPIに変更
    // const res = await fetch(`/api/chat-rooms/user/${myId}`); 
    const res = await fetch('/api/chat-rooms');
    const rooms = await res.json();
    chatRoomList.innerHTML = '';
    
    rooms.forEach(r=>{
      const div = document.createElement('div');
      div.className='chat-room';
      
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      // DMの場合は相手の名前、グループの場合はグループ名でアバターテキストを生成
      avatar.textContent = getAvatarText(r.name); 
      div.appendChild(avatar);

      const info = document.createElement('div');
      info.className = 'chat-info';
      
      const name = document.createElement('div');
      name.className = 'chat-name';
      name.textContent = r.name || (r.type === 'DM' ? 'DM相手' : 'グループ'); // 名前が空の場合はタイプを表示
      info.appendChild(name);
      
      const type = document.createElement('div');
      type.className = 'chat-type';
      type.textContent = r.type === 'DM' ? 'ダイレクトメッセージ' : 'グループチャット';
      info.appendChild(type);
      
      div.appendChild(info);

      // クリックでルーム画面へ遷移
      div.addEventListener('click', () => {
        window.location.href = `/chat/room/${r.id}`; 
      });

      chatRoomList.appendChild(div);
    });
  }

  // グループ作成画面への遷移
  createGroupBtn.addEventListener('click', () => {
    window.location.href = '/group-create'; 
  });


  document.addEventListener('DOMContentLoaded', fetchChatRooms);
</script>
</body>
</html>
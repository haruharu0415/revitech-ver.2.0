<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チャット一覧</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
      body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #ffffff; }
      
      .header-container {
          position: sticky;
          top: 0;
          z-index: 1000;
          background-color: #fff;
          box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }

      .header-bar {
          padding: 15px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      /* フィルタータブのスタイル */
      .filter-tabs {
          display: flex;
          justify-content: space-around;
          border-bottom: 1px solid #eee;
          padding-bottom: 0;
      }
      .filter-tab {
          flex: 1;
          text-align: center;
          padding: 10px 0;
          cursor: pointer;
          color: #65676b;
          font-weight: 600;
          position: relative;
          transition: color 0.2s;
      }
      .filter-tab.active {
          color: #075e54; /* LINEっぽい緑 */
      }
      .filter-tab.active::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 3px;
          background-color: #075e54;
      }
      .filter-tab:hover {
          background-color: #f5f5f5;
      }

      /* ソートエリア */
      .sort-area {
          padding: 8px 15px;
          background-color: #f8f9fa;
          display: flex;
          justify-content: flex-end;
          font-size: 0.85rem;
      }
      
      .chat-list-container {
          max-width: 800px;
          margin: 0 auto;
          min-height: calc(100vh - 120px);
          padding-bottom: 20px;
      }

      .chat-item {
          display: flex;
          align-items: center;
          padding: 15px;
          border-bottom: 1px solid #f0f0f0;
          cursor: grab; /* ドラッグできることを示すカーソル */
          transition: background-color 0.2s, transform 0.2s;
          text-decoration: none;
          color: inherit;
          background: #fff;
      }
      .chat-item:active {
          cursor: grabbing;
      }
      .chat-item:hover {
          background-color: #f5f5f5;
      }
      /* ドラッグ中のスタイル */
      .sortable-ghost {
          opacity: 0.4;
          background-color: #e9ecef;
      }

      .chat-icon {
          width: 55px;
          height: 55px;
          border-radius: 20px; /* 少し丸角に */
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 26px;
          margin-right: 15px;
          flex-shrink: 0;
          position: relative;
      }
      .chat-icon.dm { background-color: #e7f3ff; color: #1877f2; }
      .chat-icon.group { background-color: #e4f7e8; color: #20a146; }

      .chat-content {
          flex-grow: 1;
          overflow: hidden;
      }

      .chat-name {
          font-weight: bold;
          font-size: 16px;
          margin-bottom: 4px;
          color: #111;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .chat-meta {
          font-size: 13px;
          color: #888;
          display: flex;
          justify-content: space-between;
      }

      .unread-badge {
          background-color: #fa3e3e;
          color: white;
          border-radius: 50%;
          padding: 0 6px;
          font-size: 11px;
          height: 20px;
          min-width: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          margin-left: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .empty-state {
          text-align: center;
          padding: 50px 20px;
          color: #aaa;
      }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="header-bar">
            <div class="d-flex align-items-center">
                <a href="/home" class="text-decoration-none text-dark me-3"><i class="bi bi-arrow-left fs-4"></i></a>
                <h4 class="m-0 fw-bold">トーク</h4>
            </div>
            <div>
                <a href="/user-search" class="btn btn-light btn-sm rounded-pill me-1"><i class="bi bi-search"></i> 検索</a>
                <a href="/group-create" class="btn btn-success btn-sm rounded-pill"><i class="bi bi-people-fill"></i> 作成</a>
            </div>
        </div>

        <div class="filter-tabs">
            <div class="filter-tab active" onclick="setFilter('ALL')">すべて</div>
            <div class="filter-tab" onclick="setFilter('GROUP')">グループ</div>
            <div class="filter-tab" onclick="setFilter('DM')">DM</div>
        </div>

        <div class="sort-area">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle border-0" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-sort-down"></i> 並び替え
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="setSort('newest')">新着順 (デフォルト)</a></li>
                    <li><a class="dropdown-item" href="#" onclick="setSort('oldest')">古い順</a></li>
                    <li><a class="dropdown-item" href="#" onclick="setSort('name')">名前順</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="chat-list-container">
        <div id="chatListArea">
            <div class="text-center mt-5">
                <div class="spinner-border text-secondary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数としてデータを保持
        let allRooms = [];
        let currentFilter = 'ALL';
        let currentSort = 'newest';

        document.addEventListener('DOMContentLoaded', async () => {
            const chatListArea = document.getElementById('chatListArea');

            try {
                const response = await fetch('/api/chat-rooms/my-rooms');
                if (!response.ok) throw new Error('データ取得エラー');
                allRooms = await response.json();

                // 初回描画
                renderChatList();

            } catch (error) {
                console.error(error);
                chatListArea.innerHTML = '<p class="text-danger text-center p-4">読み込みに失敗しました。</p>';
            }
        });

        // フィルター切り替え関数
        function setFilter(type) {
            currentFilter = type;
            
            // タブの見た目を更新
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            // クリックされたタブをActiveにする簡易ロジック（本来はIDなどで判定）
            const tabs = document.querySelectorAll('.filter-tab');
            if (type === 'ALL') tabs[0].classList.add('active');
            if (type === 'GROUP') tabs[1].classList.add('active');
            if (type === 'DM') tabs[2].classList.add('active');

            renderChatList();
        }

        // ソート切り替え関数
        function setSort(type) {
            currentSort = type;
            renderChatList();
        }

        // リスト描画関数
        function renderChatList() {
            const chatListArea = document.getElementById('chatListArea');
            chatListArea.innerHTML = '';

            // 1. フィルタリング
            let filteredRooms = allRooms.filter(room => {
                if (currentFilter === 'ALL') return true;
                // typeが 1:DM, 2:Group と想定
                if (currentFilter === 'DM') return room.type === 1 || room.type === 'DM';
                if (currentFilter === 'GROUP') return room.type === 2 || room.type === 'GROUP';
                return true;
            });

            // 2. ソート
            filteredRooms.sort((a, b) => {
                if (currentSort === 'name') {
                    return (a.name || '').localeCompare(b.name || '');
                } else if (currentSort === 'oldest') {
                    const dateA = a.lastMessageTimestamp ? new Date(a.lastMessageTimestamp) : new Date(0);
                    const dateB = b.lastMessageTimestamp ? new Date(b.lastMessageTimestamp) : new Date(0);
                    return dateA - dateB;
                } else {
                    // newest (default)
                    const dateA = a.lastMessageTimestamp ? new Date(a.lastMessageTimestamp) : new Date(0);
                    const dateB = b.lastMessageTimestamp ? new Date(b.lastMessageTimestamp) : new Date(0);
                    return dateB - dateA;
                }
            });

            // 表示データがない場合
            if (filteredRooms.length === 0) {
                chatListArea.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-chat-square-text fs-1 mb-3 d-block"></i>
                        <p>該当するチャットはありません</p>
                    </div>
                `;
                return;
            }

            // 3. HTML生成
            filteredRooms.forEach(room => {
                // コンテナ (aタグだとドラッグ時に挙動が怪しくなることがあるため div でラップして click イベントにする手もあるが、
                // SortableJS は aタグでも動作する)
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.onclick = (e) => {
                    // ドラッグ終了時のクリック暴発を防ぐ簡単な制御を入れると良いが、今回はシンプルに遷移
                    window.location.href = `/chat/room/${room.roomId}`;
                };

                // アイコン
                const isGroup = room.type === 2 || room.type === 'GROUP';
                const iconDiv = document.createElement('div');
                iconDiv.className = `chat-icon ${isGroup ? 'group' : 'dm'}`;
                iconDiv.innerHTML = isGroup ? '<i class="bi bi-people-fill"></i>' : '<i class="bi bi-person-fill"></i>';

                // コンテンツ
                const contentDiv = document.createElement('div');
                contentDiv.className = 'chat-content';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'chat-name';
                nameDiv.textContent = room.name || (isGroup ? 'グループ' : '名無し');

                const metaDiv = document.createElement('div');
                metaDiv.className = 'chat-meta';
                
                // 日付
                let dateStr = '';
                if (room.lastMessageTimestamp) {
                    const date = new Date(room.lastMessageTimestamp);
                    const now = new Date();
                    if (date.toDateString() === now.toDateString()) {
                        dateStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    } else {
                        dateStr = date.toLocaleDateString();
                    }
                }
                metaDiv.textContent = dateStr;

                contentDiv.appendChild(nameDiv);
                contentDiv.appendChild(metaDiv);

                item.appendChild(iconDiv);
                item.appendChild(contentDiv);

                // 未読バッジ
                if (room.unreadCount > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'unread-badge';
                    badge.textContent = room.unreadCount > 99 ? '99+' : room.unreadCount;
                    item.appendChild(badge);
                }

                chatListArea.appendChild(item);
            });

            // 4. ドラッグ＆ドロップの有効化 (SortableJS)
            // リストが再描画されるたびに適用
            if (Sortable) {
                Sortable.create(chatListArea, {
                    animation: 150, // アニメーション速度
                    delay: 200,     // 誤操作防止のため、200ms長押しでドラッグ開始
                    delayOnTouchOnly: true, // タッチデバイスのみ長押し必須
                    ghostClass: 'sortable-ghost', // ドラッグ中のクラス
                    onEnd: function (evt) {
                        // ドラッグ終了時の処理（ここで並び順を保存するAPIを呼ぶのが本来の姿）
                        console.log('並び替えました: ', evt.oldIndex, '->', evt.newIndex);
                        // ※今回はDBに並び順カラムがないため、見た目だけ変わります
                    }
                });
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
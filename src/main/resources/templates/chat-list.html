<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>チャット一覧</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
      body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #ffffff; }
      
      .header-container {
          position: sticky;
          top: 0;
          z-index: 1000;
          background-color: #fff;
          box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }

      .header-bar {
          padding: 15px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .filter-tabs {
          display: flex;
          justify-content: space-around;
          border-bottom: 1px solid #eee;
          padding-bottom: 0;
      }
      .filter-tab {
          flex: 1;
          text-align: center;
          padding: 10px 0;
          cursor: pointer;
          color: #65676b;
          font-weight: 600;
          position: relative;
          transition: color 0.2s;
      }
      .filter-tab.active {
          color: #075e54;
      }
      .filter-tab.active::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 100%;
          height: 3px;
          background-color: #075e54;
      }
      .filter-tab:hover {
          background-color: #f5f5f5;
      }

      .sort-area {
          padding: 8px 15px;
          background-color: #f8f9fa;
          display: flex;
          justify-content: flex-end;
          font-size: 0.85rem;
      }
      
      .chat-list-container {
          max-width: 800px;
          margin: 0 auto;
          min-height: calc(100vh - 120px);
          padding-bottom: 20px;
      }

      .chat-item {
          display: flex;
          align-items: center;
          padding: 15px;
          border-bottom: 1px solid #f0f0f0;
          cursor: grab;
          transition: background-color 0.2s, transform 0.2s;
          text-decoration: none;
          color: inherit;
          background: #fff;
          position: relative; 
      }
      .chat-item:active {
          cursor: grabbing;
      }
      .chat-item:hover {
          background-color: #f5f5f5;
      }
      .sortable-ghost {
          opacity: 0.4;
          background-color: #e9ecef;
      }

      .chat-icon {
          width: 55px;
          height: 55px;
          border-radius: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 26px;
          margin-right: 15px;
          flex-shrink: 0;
          position: relative;
      }
      .chat-icon.dm { background-color: #e7f3ff; color: #1877f2; }
      .chat-icon.group { background-color: #e4f7e8; color: #20a146; }

      .chat-content {
          flex-grow: 1;
          overflow: hidden;
      }

      .chat-name {
          font-weight: bold;
          font-size: 16px;
          margin-bottom: 4px;
          color: #111;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      .chat-meta {
          font-size: 13px;
          color: #888;
          display: flex;
          justify-content: space-between;
      }

      .unread-badge {
          background-color: #fa3e3e;
          color: white;
          border-radius: 50%;
          padding: 0 6px;
          font-size: 11px;
          height: 20px;
          min-width: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          margin-left: 10px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .delete-group-btn {
          color: #dc3545;
          margin-left: 10px;
          cursor: pointer;
          font-size: 1.2rem;
          padding: 5px;
          z-index: 10; 
      }
      .delete-group-btn:hover {
          background-color: #fce4e4;
          border-radius: 50%;
      }

      /* メンバー管理ボタンのスタイル */
      .manage-group-btn {
          color: #198754; /* Success green */
          margin-left: 10px;
          cursor: pointer;
          font-size: 1.2rem;
          padding: 5px;
          z-index: 10;
      }
      .manage-group-btn:hover {
          background-color: #e4f7e8;
          border-radius: 50%;
      }
      
      .empty-state {
          text-align: center;
          padding: 50px 20px;
          color: #aaa;
      }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="header-bar">
            <div class="d-flex align-items-center">
                <a href="/option" class="text-decoration-none text-dark me-3"><i class="bi bi-arrow-left fs-4"></i></a>
                <h4 class="m-0 fw-bold">トーク</h4>
            </div>
            <div>
                <a href="/user-search" class="btn btn-light btn-sm rounded-pill me-1"><i class="bi bi-search"></i> 検索</a>
                <a th:if="${canCreateGroup}" href="/group-create" class="btn btn-success btn-sm rounded-pill"><i class="bi bi-people-fill"></i> 作成</a>
            </div>
        </div>

        <div class="filter-tabs">
            <div class="filter-tab active" onclick="setFilter('ALL')">すべて</div>
            <div class="filter-tab" onclick="setFilter('GROUP')">グループ</div>
            <div class="filter-tab" onclick="setFilter('DM')">DM</div>
        </div>

        <div class="sort-area">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle border-0" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-sort-down"></i> 並び替え
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="setSort('newest')">新着順 (デフォルト)</a></li>
                    <li><a class="dropdown-item" href="#" onclick="setSort('oldest')">古い順</a></li>
                    <li><a class="dropdown-item" href="#" onclick="setSort('name')">名前順</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="chat-list-container">
        <div id="chatListArea">
            <div class="text-center mt-5">
                <div class="spinner-border text-secondary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // サーバーから権限フラグを受け取る (Controllerで設定した canCreateGroup)
        const canManageGroup = /*[[${canCreateGroup}]]*/ false;
        
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
        
        let allRooms = [];
        let currentFilter = 'ALL';
        let currentSort = 'newest';

        document.addEventListener('DOMContentLoaded', async () => {
            const chatListArea = document.getElementById('chatListArea');

            try {
                // APIからチャットルーム一覧を取得
                const response = await fetch('/api/chat-rooms/my-rooms');
                if (!response.ok) throw new Error('データ取得エラー');
                allRooms = await response.json();
                renderChatList();
            } catch (error) {
                console.error(error);
                chatListArea.innerHTML = '<p class="text-danger text-center p-4">読み込みに失敗しました。</p>';
            }
        });

        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            const tabs = document.querySelectorAll('.filter-tab');
            if (type === 'ALL') tabs[0].classList.add('active');
            if (type === 'GROUP') tabs[1].classList.add('active');
            if (type === 'DM') tabs[2].classList.add('active');
            renderChatList();
        }

        function setSort(type) {
            currentSort = type;
            renderChatList();
        }

        async function deleteGroup(event, roomId, roomName) {
            event.stopPropagation();
            
            if (!confirm(`グループ「${roomName}」を削除しますか？\nこの操作は元に戻せません。`)) {
                return;
            }

            try {
                const response = await fetch(`/chat-room/delete/${roomId}`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });
                
                if (response.ok || response.redirected) {
                    window.location.reload();
                } else {
                    alert('削除に失敗しました。');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('エラーが発生しました。');
            }
        }

        function renderChatList() {
            const chatListArea = document.getElementById('chatListArea');
            chatListArea.innerHTML = '';

            let filteredRooms = allRooms.filter(room => {
                if (currentFilter === 'ALL') return true;
                if (currentFilter === 'DM') return room.type === 1 || room.type === 'DM';
                if (currentFilter === 'GROUP') return room.type === 2 || room.type === 'GROUP';
                return true;
            });

            filteredRooms.sort((a, b) => {
                if (currentSort === 'name') {
                    return (a.name || '').localeCompare(b.name || '');
                } else if (currentSort === 'oldest') {
                    const dateA = a.lastMessageTimestamp ? new Date(a.lastMessageTimestamp) : new Date(0);
                    const dateB = b.lastMessageTimestamp ? new Date(b.lastMessageTimestamp) : new Date(0);
                    return dateA - dateB;
                } else {
                    const dateA = a.lastMessageTimestamp ? new Date(a.lastMessageTimestamp) : new Date(0);
                    const dateB = b.lastMessageTimestamp ? new Date(b.lastMessageTimestamp) : new Date(0);
                    return dateB - dateA;
                }
            });

            if (filteredRooms.length === 0) {
                chatListArea.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-chat-square-text fs-1 mb-3 d-block"></i>
                        <p>該当するチャットはありません</p>
                    </div>
                `;
                return;
            }

            filteredRooms.forEach(room => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                
                // ★★★ ここで遷移先を分岐させます ★★★
                item.onclick = (e) => {
                    const isGroup = (room.type === 2 || room.type === 'GROUP');
                    
                    if (isGroup) {
                        // グループチャット画面へ遷移
                        window.location.href = `/group/chat/${room.roomId}`;
                    } else {
                        // 従来のDMチャット画面へ遷移
                        window.location.href = `/chat/room/${room.roomId}`;
                    }
                };

                const isGroup = room.type === 2 || room.type === 'GROUP';
                const iconDiv = document.createElement('div');
                iconDiv.className = `chat-icon ${isGroup ? 'group' : 'dm'}`;
                iconDiv.innerHTML = isGroup ? '<i class="bi bi-people-fill"></i>' : '<i class="bi bi-person-fill"></i>';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'chat-content';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'chat-name';
                const roomName = room.name || (isGroup ? 'グループ' : '名無し');
                nameDiv.textContent = roomName;

                const metaDiv = document.createElement('div');
                metaDiv.className = 'chat-meta';
                
                let dateStr = '';
                if (room.lastMessageTimestamp) {
                    const date = new Date(room.lastMessageTimestamp);
                    const now = new Date();
                    if (date.toDateString() === now.toDateString()) {
                        dateStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    } else {
                        dateStr = date.toLocaleDateString();
                    }
                }
                metaDiv.textContent = dateStr;

                contentDiv.appendChild(nameDiv);
                contentDiv.appendChild(metaDiv);

                item.appendChild(iconDiv);
                item.appendChild(contentDiv);

                if (room.unreadCount > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'unread-badge';
                    badge.textContent = room.unreadCount > 99 ? '99+' : room.unreadCount;
                    item.appendChild(badge);
                }

                if (canManageGroup && isGroup) {
                    // メンバー管理ボタン（歯車アイコン）
                    const manageBtn = document.createElement('div');
                    manageBtn.className = 'manage-group-btn';
                    manageBtn.title = 'メンバー管理';
                    manageBtn.innerHTML = '<i class="bi bi-gear-fill"></i>';
                    manageBtn.onclick = (e) => {
                        e.stopPropagation(); // チャット遷移をキャンセル
                        window.location.href = `/group/manage/${room.roomId}`;
                    };
                    item.appendChild(manageBtn);

                    // 削除ボタン
                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'delete-group-btn';
                    deleteBtn.title = 'グループ削除';
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteBtn.onclick = (e) => deleteGroup(e, room.roomId, roomName);
                    item.appendChild(deleteBtn);
                }

                chatListArea.appendChild(item);
            });

            if (Sortable) {
                Sortable.create(chatListArea, {
                    animation: 150,
                    delay: 200,
                    delayOnTouchOnly: true,
                    ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        console.log('並び替えました: ', evt.oldIndex, '->', evt.newIndex);
                    }
                });
            }
        }
        /*]]>*/
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
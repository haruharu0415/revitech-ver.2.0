<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>グループチャット</title>
<th:block th:insert="~{header :: header-styles}"></th:block>
<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#e5ddd5; margin:0; padding:0; display:flex; flex-direction:column; }
  header { background:#075e54; color:white; padding:15px; font-size:20px; font-weight:bold; }
  #chatRoomList { flex-grow:1; overflow-y:auto; padding:10px; }
  .chat-room { background:white; border-radius:8px; margin-bottom:10px; display:flex; align-items:center; padding:10px; box-shadow:0 2px 3px rgba(0,0,0,0.1); cursor:pointer; }
  .avatar { width:50px; height:50px; background:#25d366; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:20px; margin-right:15px; user-select:none; }
  .chat-info { flex-grow:1; }
  .chat-name { font-weight:600; font-size:16px; color:#111; }
  .chat-type { font-size:12px; color:#666; margin-top:3px; }
  #createGroupBtn { position:fixed; bottom:30px; right:30px; width:60px; height:60px; background:#25d366; border-radius:50%; border:none; color:white; font-size:30px; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>
	<div th:replace="~{header :: header-fragment}"></div>

<header>グループチャットルーム</header>
<div id="chatRoomList"></div>
<button id="createGroupBtn">＋</button>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const chatRoomList = document.getElementById('chatRoomList');
    const createGroupBtn = document.getElementById('createGroupBtn');

    // アバターのテキストを生成
    function getAvatarText(name){ 
      return name ? name.charAt(0).toUpperCase() : "?"; 
    }

    try {
      // ★ 1. 全員分ではなく、自分専用のルームリストを取得するAPIを呼び出します
      const response = await fetch('/api/chat-rooms/my-rooms');
      
      if (!response.ok) {
        throw new Error('ルームリストの取得に失敗しました。');
      }
      
      const rooms = await response.json();
      chatRoomList.innerHTML = ''; // 一旦クリア
      
      // ★ 2. ルームが0件の場合のメッセージを表示します
      if (rooms.length === 0) {
        chatRoomList.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">参加しているグループチャットはありません。</p>';
        return;
      }
      
      // ★ 3. 取得したルームを描画します (元のコードと同じロジックです)
      rooms.forEach(room => {
        const div = document.createElement('div');
        div.className = 'chat-room';
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.textContent = getAvatarText(room.name); 
        div.appendChild(avatar);

        const info = document.createElement('div');
        info.className = 'chat-info';
        
        const name = document.createElement('div');
        name.className = 'chat-name';
        name.textContent = room.name || 'DM';
        info.appendChild(name);
        
        const type = document.createElement('div');
        type.className = 'chat-type';
        type.textContent = room.type === 'DM' ? 'ダイレクトメッセージ' : 'グループチャット';
        info.appendChild(type);
        
        div.appendChild(info);

        div.addEventListener('click', () => {
          window.location.href = `/chat/room/${room.id}`; 
        });

        chatRoomList.appendChild(div);
      });

    } catch (error) {
      // ★ 4. エラーが発生した場合のメッセージを表示します
      console.error('Fetch Error:', error);
      chatRoomList.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">${error.message}</p>`;
    }

    // グループ作成画面への遷移
    createGroupBtn.addEventListener('click', () => {
      window.location.href = '/group-create'; 
    });
  });
</script>
</body>
</html>